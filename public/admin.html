<!-- =========================================================
  admin.html ‚Äî PAINEL ADMIN (100% compat√≠vel com seu Google Apps Script)
  - Login por "key" (senha) => action=loginAdmin&key=...
  - L√™ abas: clientes, beneficios, promocoes, logs, log_admin, admins (via ?aba=...)
  - Parceiros: lista via action=listar_parceiros (e permite atualizar via action=atualizar_parceiro)
  - Ativar/Desativar: action=alterar_status (clientes/parceiros/beneficios/promocoes)
  - Criar: clientes/parceiros/beneficio/promocao (actions criar_*)
  - Relat√≥rio: action=relatorioGeral
  - Gerar PDFs: action=gerarContrato (parceiro) / action=gerar_termos_cliente (cliente)
  - JSONP (sem CORS): injeta <script> com callback
========================================================= -->

<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Admin ‚Äî AproveitAI</title>

  <style>
    :root{
      --bg:#f4f7fb;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#64748b;
      --line:#e2e8f0;
      --good:#16a34a;
      --bad:#dc2626;
      --warn:#f59e0b;
      --brand:#0ea5e9;
      --brand2:#22c55e;
      --shadow: 0 10px 25px rgba(2,6,23,.08);
      --radius:16px;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--text);
      background: radial-gradient(1200px 600px at 20% -10%, rgba(14,165,233,.18), transparent 60%),
                  radial-gradient(1000px 600px at 80% -10%, rgba(34,197,94,.14), transparent 60%),
                  var(--bg);
    }

    .wrap{
  width: 100%;
  max-width: 100%;
  margin: 0;
  padding: 18px;
}

    .topbar{
      background: linear-gradient(90deg, rgba(14,165,233,.18), rgba(34,197,94,.14));
      border:1px solid var(--line);
      border-radius: var(--radius);
      padding:14px 14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      box-shadow: var(--shadow);
    }

    .brand{
      display:flex; align-items:center; gap:12px;
    }
    .badge{
      width:44px;height:44px;border-radius:14px;
      background: linear-gradient(135deg, var(--brand), var(--brand2));
      display:grid;place-items:center;
      color:white;font-weight:800;
      box-shadow: 0 10px 18px rgba(14,165,233,.22);
    }
    .brand h1{margin:0;font-size:16px;line-height:1.1}
    .brand small{color:var(--muted);display:block;margin-top:2px}

    .right{
      display:flex; align-items:center; gap:10px; flex-wrap:wrap;
      justify-content:flex-end;
    }

    .pill{
      border:1px solid var(--line);
      background: rgba(255,255,255,.8);
      padding:8px 10px;
      border-radius:999px;
      font-size:12px;
      color:var(--muted);
      display:flex;
      align-items:center;
      gap:8px;
    }

    .btn{
      border:1px solid var(--line);
      background: var(--card);
      color: var(--text);
      padding:10px 12px;
      border-radius: 12px;
      cursor:pointer;
      font-weight:700;
      box-shadow: 0 6px 14px rgba(2,6,23,.06);
    }
    .btn:hover{transform: translateY(-1px)}
    .btn:active{transform: translateY(0px)}
    .btn.primary{
      border:none;
      background: linear-gradient(135deg, var(--brand), var(--brand2));
      color:white;
    }
    .btn.danger{
      border:1px solid rgba(220,38,38,.35);
      background: rgba(220,38,38,.08);
      color: var(--bad);
    }

    .grid{
  margin-top:16px;
  display:grid;
  grid-template-columns: 300px minmax(0, 1fr);
  gap:14px;
}


    @media (max-width: 980px){
      .grid{grid-template-columns:1fr}
    }

    .side, .main{
      background: rgba(255,255,255,.75);
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }

    .side{
      padding:10px;
    }

    .navbtn{
      width:100%;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid transparent;
      background: transparent;
      cursor:pointer;
      text-align:left;
      font-weight:800;
      color: #0b1220;
    }
    .navbtn small{display:block;font-weight:600;color:var(--muted);margin-top:2px}
    .navbtn.active{
      border-color: rgba(14,165,233,.35);
      background: linear-gradient(90deg, rgba(14,165,233,.12), rgba(34,197,94,.10));
    }

    .mainHeader{
      padding:14px 14px 0 14px;
    }
    .titleRow{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
    }
    .titleRow h2{margin:0;font-size:18px}
    .titleRow p{margin:6px 0 0 0;color:var(--muted);font-size:13px}

    .content{
      padding:14px;
    }

    .cards{
      display:grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap:12px;
    }
    @media (max-width: 1000px){
      .cards{grid-template-columns: repeat(2, minmax(0, 1fr));}
    }
    @media (max-width: 520px){
      .cards{grid-template-columns: 1fr;}
    }

    .card{
      background: rgba(255,255,255,.9);
      border:1px solid var(--line);
      border-radius: var(--radius);
      padding:12px;
      box-shadow: 0 8px 18px rgba(2,6,23,.05);
    }
    .card b{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
    .card .big{font-size:22px;font-weight:900}

    .row{
      display:flex;gap:10px;flex-wrap:wrap;align-items:center;
      margin-bottom:12px;
    }
    .input, select, textarea{
      border:1px solid var(--line);
      background: rgba(255,255,255,.95);
      padding:10px 10px;
      border-radius: 12px;
      outline:none;
      min-width: 180px;
      font-weight:700;
      color: var(--text);
    }
    textarea{min-height:90px;min-width:280px;font-weight:600}

    .hint{font-size:12px;color:var(--muted)}
    .hr{height:1px;background:var(--line);margin:12px 0}

    .status{
      display:inline-flex;align-items:center;gap:8px;
      font-weight:900;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.8);
      font-size:12px;
    }
    .dot{width:10px;height:10px;border-radius:999px;background:var(--muted)}
    .status.ok{border-color: rgba(22,163,74,.25); background: rgba(22,163,74,.08); color: var(--good)}
    .status.ok .dot{background: var(--good)}
    .status.bad{border-color: rgba(220,38,38,.25); background: rgba(220,38,38,.08); color: var(--bad)}
    .status.bad .dot{background: var(--bad)}

    .tableWrap{
  width: 100%;
  overflow-x: auto;
}

table{
  width: 100%;
  min-width: 1100px; /* for√ßa abrir scroll horizontal */
  border-collapse: collapse;
  table-layout: fixed;
}

th, td{
  word-break: break-word;
  white-space: normal;
}

    th, td{
      border-bottom:1px solid var(--line);
      padding:10px 10px;
      text-align:left;
      vertical-align:top;
      font-size:13px;
    }
    th{
      position:sticky; top:0;
      background: rgba(248,250,252,.95);
      z-index:1;
      font-size:12px;
      color: var(--muted);
      text-transform:uppercase;
      letter-spacing:.04em;
    }
    td .mini{
      font-size:12px;color:var(--muted);font-weight:700;
    }

    .chip{
      display:inline-flex;align-items:center;gap:6px;
      padding:6px 10px;border-radius:999px;
      border:1px solid var(--line);
      font-weight:900;font-size:12px;
      background: rgba(255,255,255,.85);
    }
    .chip.green{border-color: rgba(22,163,74,.25); background: rgba(22,163,74,.08); color: var(--good)}
    .chip.red{border-color: rgba(220,38,38,.25); background: rgba(220,38,38,.08); color: var(--bad)}

    .toast{
      position:fixed; left:50%; bottom:18px; transform:translateX(-50%);
      background: rgba(15,23,42,.92);
      color:#fff;
      padding:10px 12px;
      border-radius: 12px;
      font-weight:800;
      box-shadow: 0 18px 35px rgba(2,6,23,.35);
      opacity:0;
      pointer-events:none;
      transition:.18s ease;
      max-width: calc(100% - 24px);
    }
    .toast.show{opacity:1; transform:translateX(-50%) translateY(-2px);}
         /* Login modal */
    .overlay{
      position:fixed; inset:0;
      background: rgba(2,6,23,.55);
      display:none;
      align-items:center;
      justify-content:center;
      padding:18px;
      z-index:100;
    }
    .overlay.show{display:flex}
    .modal{
      width:min(520px, 100%);
      background: rgba(255,255,255,.96);
      border:1px solid var(--line);
      border-radius: 18px;
      box-shadow: 0 30px 60px rgba(2,6,23,.25);
      overflow:hidden;
    }
    .modal header{
      padding:14px 14px;
      background: linear-gradient(90deg, rgba(14,165,233,.18), rgba(34,197,94,.14));
      border-bottom:1px solid var(--line);
      display:flex; align-items:center; justify-content:space-between; gap:12px;
    }
    .modal header b{font-size:14px}
    .modal .body{padding:14px}
    .modal .body p{margin:0 0 10px 0;color:var(--muted);font-weight:700}
/* =========================
   CABE√áALHO
========================= */
.site-header {
  background: white;
  padding: 10px;
  box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}

.brandline {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 15px;
  flex-wrap: wrap;
}

.logo {
  max-height: 180px;
  height: auto;
  width: auto;
  object-fit: contain;
}

.brand-center {
  flex: 1;
  text-align: center;
}

.site-title {
  font-size: 36px;
  color: #0a7a2a;
  text-shadow: 1px 1px 3px rgba(0,0,0,0.3);
  font-weight: bold;
}

.slogan {
  font-size: 16px;
  font-style: italic;
  margin-bottom: 5px;
  color: #555;
}

.boas-vindas {
  background: #dfffe0;
  padding: 12px 15px;
  border-radius: 8px;
  margin-top: 10px;
  font-size: 18px; /* AUMENTADO */
  line-height: 1.5;
  font-weight: 600;
  box-shadow: 0 1px 3px rgba(0,0,0,0.08);
}
html, body {
  width: 100%;
  overflow-x: hidden;
}

.main-content {
  max-width: 100%;
  padding: 16px;
}

table {
  width: 100%;
  table-layout: fixed;
}

th, td {
  word-wrap: break-word;
  white-space: normal;
}

@media (max-width: 1200px) {
  }
}
html, body {
  width: 100%;
  max-width: 100%;
  overflow-x: hidden;
}

.main-content,
.container,
.dashboard,
.table-wrapper {
  max-width: 100%;
  width: 100%;
}

table {
  width: 100%;
  table-layout: fixed;
}

th, td {
  word-wrap: break-word;
}
table td, table th {
  padding: 6px 8px;
  font-size: 13px;
  vertical-align: middle;
}


button {
  min-width: 90px;
  padding: 8px 12px;
  margin: 4px 0;
}
/* =========================
   AJUSTE VISUAL TABELAS ADMIN
========================= */

/* Container da tabela */
.table-container,
.table-wrapper {
  width: 100%;
  overflow-x: auto;
  margin-top: 12px;
  border-radius: 12px;
}

/* Tabela base */
table {
  width: 100%;
  min-width: 1200px; /* FOR√áA largura m√≠nima */
  border-collapse: collapse;
  table-layout: fixed;
  background: #fff;
}

/* Cabe√ßalho */
table thead th {
  background: #f1f5f9;
  color: #0f172a;
  font-weight: 700;
  font-size: 13px;
  padding: 10px 8px;
  border-bottom: 2px solid #e2e8f0;
  text-align: left;
  white-space: nowrap;
}

/* Corpo */
table tbody td {
  padding: 10px 8px;
  font-size: 13px;
  border-bottom: 1px solid #e5e7eb;
  vertical-align: top;
  word-break: break-word;
  white-space: normal;
}

/* Zebra */
table tbody tr:nth-child(even) {
  background: #f8fafc;
}

/* Status */
td[data-status="sim"] {
  color: #166534;
  font-weight: 700;
}

td[data-status="nao"] {
  color: #991b1b;
  font-weight: 700;
}

/* Bot√µes */
table button {
  padding: 6px 10px;
  margin: 2px 0;
  border-radius: 8px;
  font-size: 12px;
  min-width: 90px;
  cursor: pointer;
}

/* Coluna a√ß√µes */
table td, table th{
  padding: 6px 8px;
  font-size: 13px;
  vertical-align: middle;
}

td.acoes button {
  padding: 6px 10px;
  font-size: 12px;
}


/* Scroll bonito */
.table-container::-webkit-scrollbar {
  height: 8px;
}
.table-container::-webkit-scrollbar-thumb {
  background: #cbd5f5;
  border-radius: 10px;
}
td.acoes{
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
  align-items: center;
}
td.acoes{
  display:flex;
  flex-wrap:wrap;
  gap:6px;
  align-items:center;
}
td.acoes button{
  padding:6px 10px;
  font-size:12px;
}

table td, table th{
  padding:6px 8px;
  font-size:13px;
  vertical-align:middle;
}


  </style>
</head>

<body>
<!-- ‚úÖ CABE√áALHO PADRONIZADO -->
<header class="site-header">
  <div class="brandline">
    <img src="logo-prometheus.png" class="logo logo-prometheus">
    <div class="brand-center">
      <h1 class="site-title">Cart√£o AproveitAI</h1>
      <p class="slogan">Tecnologia com Consci√™ncIA gera Resultado.</p>

      <!-- Tarja -->
      <p class="boas-vindas">
        üè™ <strong>PAINEL ADMINISTRA√á√ÉO</strong><br>
        Controle e administra√ß√£o total do site.
      </p>
    </div>
    <img src="logo-aproveitai.png" class="logo logo-aproveitai">
  </div>
</header>

  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="badge">A</div>
        <div>
          <h1>Admin ‚Äî AproveitAI</h1>
          <small id="subinfo">√öltima atualiza√ß√£o: <span id="ultima"></span></small>
        </div>
      </div>

      <div class="right">
        <div class="pill">
          <span class="dot" style="width:10px;height:10px;border-radius:999px;background:var(--brand)"></span>
          <span id="pillAdmin">N√£o autenticado</span>
        </div>
        <button class="btn" id="btnRecarregar">Recarregar</button>
        <button class="btn danger" id="btnSair">Sair</button>
      </div>
    </div>

    <div class="grid">
      <aside class="side">
        <button class="navbtn active" data-view="dashboard">
          Dashboard
          <span class="hint">Resumo e sa√∫de do sistema</span>
        </button>

        <div class="hr"></div>

        <button class="navbtn" data-view="clientes">
          Clientes
          <small>listar + ativar/desativar + criar + termos</small>
        </button>
        <button class="navbtn" data-view="parceiros">
          Parceiros
          <small>listar + ativar/desativar + editar + criar + contrato</small>
        </button>
        <button class="navbtn" data-view="beneficios">
          Benef√≠cios
          <small>listar + ativar/desativar + criar</small>
        </button>
        <button class="navbtn" data-view="promocoes">
          Promo√ß√µes
          <small>listar + ativar/desativar + criar</small>
        </button>

        <div class="hr"></div>

        <button class="navbtn" data-view="logs">
          Logs
          <small>somente leitura</small>
        </button>
        <button class="navbtn" data-view="log_admin">
          Log Admin
          <small>somente leitura</small>
        </button>
        <button class="navbtn" data-view="admins">
          Admins
          <small>somente leitura</small>
        </button>
      </aside>

      <main class="main">
        <div class="mainHeader">
          <div class="titleRow">
            <div>
              <h2 id="viewTitle">Dashboard</h2>
              <p id="viewDesc">Resumo geral do banco e valida√ß√µes.</p>
            </div>
            <div class="row" style="margin:0">
              <span id="statusApi" class="status"><span class="dot"></span>API n√£o verificada</span>
              <button class="btn primary" id="btnTestarApi">Testar API</button>
            </div>
          </div>
          <div class="hr"></div>
        </div>

        <div class="content">
          <!-- DASHBOARD -->
          <section data-section="dashboard">
            <div class="cards">
              <div class="card">
                <b>Clientes</b>
                <div class="big" id="mClientes">‚Äî</div>
                <div class="hint" id="mClientes2">‚Äî</div>
              </div>
              <div class="card">
                <b>Parceiros</b>
                <div class="big" id="mParceiros">‚Äî</div>
                <div class="hint" id="mParceiros2">‚Äî</div>
              </div>
              <div class="card">
                <b>Valida√ß√µes (logs)</b>
                <div class="big" id="mLogs">‚Äî</div>
                <div class="hint">Registros totais no log</div>
              </div>
              <div class="card">
                <b>Status</b>
                <div class="big" id="mStatus">‚Äî</div>
                <div class="hint">API / Login</div>
              </div>
            </div>

            <div class="hr"></div>

            <div class="row">
              <button class="btn primary" id="btnCarregarTudo">Carregar tudo (r√°pido)</button>
              <span class="hint">Carrega: relat√≥rio geral + √∫ltimos dados (logs, clientes, parceiros).</span>
            </div>

            <div class="tableWrap" style="margin-top:10px">
              <table>
                <thead>
                  <tr>
                    <th>Atalho</th>
                    <th>O que faz</th>
                    <th>Observa√ß√£o</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td><b>Clientes</b></td>
                    <td>Ativar/Inativar e gerar termos do cliente (PDF)</td>

                    <td>Controle principal do pagamento via campo <b>ativo</b></td>
                  </tr>
                  <tr>
                    <td><b>Parceiros</b></td>
                    <td>Ativar/Inativar, editar campos (patch), criar novo, gerar contrato (PDF)</td>
                    <td>Lista usa action=listar_parceiros (gera log_admin automaticamente)</td>
                  </tr>
                  <tr>
                    <td><b>Benef√≠cios/Promo√ß√µes</b></td>
                    <td>Ativar/Inativar e criar registros</td>
                    <td>Edi√ß√£o avan√ßada n√£o existe no seu GAS hoje (somente status + criar)</td>
                  </tr>
                  <tr>
                    <td><b>Logs/Log Admin</b></td>
                    <td>Somente leitura</td>
                    <td>Transpar√™ncia e auditoria</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </section>

          <!-- CLIENTES -->
          <section data-section="clientes" style="display:none">
            <div class="row">
              <input class="input" id="filtroClientes" placeholder="Buscar (nome / cpf / cidade / idPublico)"/>
              <button class="btn" id="btnReloadClientes">Recarregar</button>
              <button class="btn" id="btnCsvClientes">Exportar CSV</button>
              <div>
            <div class="hint">Dica: o bot√£o de status altera a coluna <b>ativo</b> para <b>SIM</b> ou <b>NAO</b>.</div>
            <div class="hr"></div>
            <div class="tableWrap">
              <table id="tblClientes"></table>
            </div>
          </section>

          <!-- PARCEIROS -->
          <section data-section="parceiros" style="display:none">
            <div class="row">
              <input class="input" id="filtroParceiros" placeholder="Buscar (nome / cnpj / cidade / ramo)"/>
              <button class="btn" id="btnReloadParceiros">Recarregar</button>
              <button class="btn" id="btnCsvParceiros">Exportar CSV</button>
              <button class="btn primary" id="btnNovoParceiro">+ Criar Parceiro</button>
            </div>
            <div class="hint">Parceiros permitem <b>edi√ß√£o</b> via action=atualizar_parceiro (patch).</div>
            <div class="hr"></div>
            <div class="tableWrap">
              <table id="tblParceiros"></table>
            </div>
          </section>

          <!-- BENEFICIOS -->
          <section data-section="beneficios" style="display:none">
            <div class="row">
              <input class="input" id="filtroBeneficios" placeholder="Buscar (parceiro / grupo / descri√ß√£o)"/>
              <button class="btn" id="btnReloadBeneficios">Recarregar</button>
              <button class="btn" id="btnCsvBeneficios">Exportar CSV</button>
              <button class="btn primary" id="btnNovoBeneficio">+ Criar Benef√≠cio</button>
            </div>
            <div class="hr"></div>
            <div class="tableWrap">
              <table id="tblBeneficios"></table>
            </div>
          </section>

          <!-- PROMOCOES -->
          <section data-section="promocoes" style="display:none">
            <div class="row">
              <input class="input" id="filtroPromocoes" placeholder="Buscar (parceiro / t√≠tulo / descri√ß√£o)"/>
              <button class="btn" id="btnReloadPromocoes">Recarregar</button>
              <button class="btn" id="btnCsvPromocoes">Exportar CSV</button>
              <button class="btn primary" id="btnNovoPromocao">+ Criar Promo√ß√£o</button>
            </div>
            <div class="hr"></div>
            <div class="tableWrap">
              <table id="tblPromocoes"></table>
            </div>
          </section>

          <!-- LOGS -->
          <section data-section="logs" style="display:none">
            <div class="row">
              <input class="input" id="filtroLogs" placeholder="Buscar (cpf / nome / parceiro / status / tipo)"/>
              <button class="btn" id="btnReloadLogs">Recarregar</button>
              <button class="btn" id="btnCsvLogs">Exportar CSV</button>
            </div>
            <div class="hint">Somente leitura. Mostra exatamente a aba <b>logs</b>.</div>
            <div class="hr"></div>
            <div class="tableWrap">
              <table id="tblLogs"></table>
            </div>
          </section>

          <!-- LOG ADMIN -->
          <section data-section="log_admin" style="display:none">
            <div class="row">
              <input class="input" id="filtroLogAdmin" placeholder="Buscar (admin / a√ß√£o / entidade / id)"/>
              <button class="btn" id="btnReloadLogAdmin">Recarregar</button>
              <button class="btn" id="btnCsvLogAdmin">Exportar CSV</button>
            </div>
            <div class="hint">Somente leitura. Mostra a aba <b>log_admin</b>.</div>
            <div class="hr"></div>
            <div class="tableWrap">
              <table id="tblLogAdmin"></table>
            </div>
          </section>

          <!-- ADMINS -->
          <section data-section="admins" style="display:none">
            <div class="row">
              <input class="input" id="filtroAdmins" placeholder="Buscar (usuario / nome)"/>
              <button class="btn" id="btnReloadAdmins">Recarregar</button>
              <button class="btn" id="btnCsvAdmins">Exportar CSV</button>
            </div>
            <div class="hint">Somente leitura. Mostra a aba <b>admins</b> (aten√ß√£o: aqui aparecem senhas).</div>
            <div class="hr"></div>
            <div class="tableWrap">
              <table id="tblAdmins"></table>
            </div>
          </section>

        </div>
      </main>
    </div>
  </div>

  <!-- LOGIN MODAL -->
  <div class="overlay" id="overlayLogin">
    <div class="modal">
      <header>
        <b>Entrar no Admin</b>
        <span class="hint">Acesso via aba ‚Äúadmins‚Äù</span>
      </header>
      <div class="body">
        <p>Digite a <b>senha (key)</b> cadastrada na coluna <b>senha</b> da aba <b>admins</b>.</p>
        <div class="row">
          <input class="input" id="inpKey" placeholder="Senha (key) do admin" style="min-width:260px"/>
          <button class="btn primary" id="btnLogin">Entrar</button>
        </div>
        <div class="hint" id="loginMsg"></div>
      </div>
    </div>
  </div>
  <!-- EDIT MODAL (necess√°rio para Editar/Criar) -->
  <div class="overlay" id="overlayEdit">
    <div class="modal">
      <header>
        <b id="editTitle">Editar</b>
        <button class="btn" id="btnEditClose">Fechar</button>
      </header>

      <div class="body">
        <p id="editHint" class="hint"></p>

        <div class="row" id="editForm" style="align-items:flex-start;flex-wrap:wrap"></div>

        <div class="row" style="justify-content:flex-end;margin-top:12px">
          <button class="btn" id="btnEditCancel">Cancelar</button>
          <button class="btn primary" id="btnEditSave">Salvar</button>
        </div>
      </div>
    </div>
  </div>

<script>
/**************************************************************
 * ADMIN ‚Äî AproveitAI (compat√≠vel com seu Google Apps Script)
 * - JSONP (sem CORS) via callback
 * - Login: action=loginAdmin&key=...
 * - CRUD:
 *   - clientes: criar_cliente / atualizar_registro / alterar_status / gerar_termos_cliente
 *   - parceiros: criar_parceiro / atualizar_parceiro / atualizar_registro / alterar_status / gerarContrato / listar_parceiros
 *   - beneficios: criar_beneficio / atualizar_registro / alterar_status
 *   - promocoes: criar_promocao / atualizar_registro / alterar_status
 *   - logs, log_admin, admins: somente leitura via ?aba=
 **************************************************************/

/*** 1) CONFIG ‚Äî cole aqui a URL /exec do Apps Script ***/
const API_URL = "https://script.google.com/macros/s/AKfycbwMMQ2FR2JBpo7xvWVazw4dAV6t_t90UxTASLcGfo1t7fA-beDqJDC-4z-Y7DL9vRunVg/exec";

/*** 2) ESTADO ***/
const store = {
  get(k){ try{return localStorage.getItem(k)}catch(e){return null} },
  set(k,v){ try{localStorage.setItem(k,v)}catch(e){} },
  del(k){ try{localStorage.removeItem(k)}catch(e){} },
};
const state = {
  key: store.get("apv_admin_key") || null,
  admin: store.get("apv_admin_name") || null,
  cache: { clientes:[], parceiros:[], beneficios:[], promocoes:[], logs:[], log_admin:[], admins:[] },
  loaded: { clientes:false, parceiros:false, beneficios:false, promocoes:false, logs:false, log_admin:false, admins:false, dashboard:false }
};
function formatarDataBR(iso){
  if(!iso) return "";
  const d = new Date(iso);
  return d.toLocaleString("pt-BR", {
    timeZone: "America/Sao_Paulo",
    dateStyle: "short",
    timeStyle: "medium"
  });
}

/*** 3) HELPERS UI ***/
const $ = (id)=>document.getElementById(id);
function toast(msg){
  const t = $("toast");
  t.textContent = msg;
  t.classList.add("show");
  setTimeout(()=>t.classList.remove("show"), 2600);
}
function setPill(text){
  $("pillAdmin").textContent = text;
}
function setApiStatus(ok, msg){
  const el = $("statusApi");
  el.classList.remove("ok","bad");
  if(ok){ el.classList.add("ok"); el.querySelector(".dot").style.background="var(--good)"; }
  else { el.classList.add("bad"); el.querySelector(".dot").style.background="var(--bad)"; }
  el.childNodes[1].textContent = " " + msg;
}
function showOverlay(id, show){
  const el = $(id);
  if(!el) return;
  el.classList.toggle("show", !!show);
}
function apenasNumeros(v){ return String(v||"").replace(/\D/g,""); }
function escapeHtml(s){
  return String(s ?? "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#39;");
}

/*** 4) JSONP CALL ***/
async function callAPI(params = {}){
  if(state.key){
    params.key = state.key;
  }
  const url = API_URL + "?" + new URLSearchParams(params);
  const r = await fetch(url);
  return r.json();
}



/*** 5) LOGIN ***/
async function ensureLogin(){
  if(!state.key){
    showOverlay("overlayLogin", true);
    setPill("N√£o autenticado");
    return false;
  }
  try{
    const res = await callAPI({ action:"loginAdmin", key: state.key });
    if(res && res.ok){
      state.admin = res.admin || "Admin";
      store.set("apv_admin_key", state.key);
      store.set("apv_admin_name", state.admin);
      setPill("Logado: " + state.admin);
      showOverlay("overlayLogin", false);
      return true;
    }
    throw res;
  }catch(err){
    state.key = null;
    state.admin = null;
    store.del("apv_admin_key");
    store.del("apv_admin_name");
    setPill("N√£o autenticado");
    showOverlay("overlayLogin", true);
    $("loginMsg").textContent = "Acesso negado. Verifique a key na aba 'admins'.";
    return false;
  }
}

function logout(){
  state.key=null; state.admin=null;
  store.del("apv_admin_key"); store.del("apv_admin_name");
  setPill("N√£o autenticado");
  toast("Saiu do admin");
  showOverlay("overlayLogin", true);
}

/*** 6) NAV / VIEW ***/
const views = {
  dashboard: { title:"Dashboard", desc:"Resumo geral do banco e valida√ß√µes." },
  clientes: { title:"Clientes", desc:"Criar, editar, ativar/desativar e gerar termos." },
  parceiros: { title:"Parceiros", desc:"Criar, editar, ativar/desativar, token e contrato." },
  beneficios: { title:"Benef√≠cios", desc:"Criar, editar e ativar/desativar benef√≠cios." },
  promocoes: { title:"Promo√ß√µes", desc:"Criar, editar e ativar/desativar promo√ß√µes." },
  logs: { title:"Logs", desc:"Somente leitura (valida√ß√µes)." },
  log_admin: { title:"Log Admin", desc:"Somente leitura (auditoria)." },
  admins: { title:"Admins", desc:"Somente leitura (aten√ß√£o √†s senhas)." }
};

function showView(name){
  // nav state
  document.querySelectorAll(".navbtn").forEach(b=>{
    b.classList.toggle("active", b.dataset.view === name);
  });
  // title
  $("viewTitle").textContent = views[name]?.title || name;
  $("viewDesc").textContent = views[name]?.desc || "";
  // section
  document.querySelectorAll("section[data-section]").forEach(s=>{
    s.style.display = (s.dataset.section === name) ? "" : "none";
  });

  // lazy load
  loadView(name).catch(()=>{});
}

async function loadView(name){
  if(!(await ensureLogin())) return;

  if(name === "dashboard") return loadDashboard(true);
  if(name === "clientes") return loadClientes(true);
  if(name === "parceiros") return loadParceiros(true);
  if(name === "beneficios") return loadBeneficios(true);
  if(name === "promocoes") return loadPromocoes(true);
  if(name === "logs") return loadLogs(true);
  if(name === "log_admin") return loadLogAdmin(true);
  if(name === "admins") return loadAdmins(true);
}

/*** 7) RENDER TABLES ***/
function chipAtivo(v){
  const on = String(v||"").trim().toLowerCase() === "sim";
  return `<span class="chip ${on?'green':'red'}">${on?'ATIVO':'INATIVO'}</span>`;
}

function renderTable(tableId, rows, columns, options={}){
  const tbl = $(tableId);
  const cols = columns.filter(Boolean);

  const thead = `<thead><tr>${
    cols.map(c=>`<th>${escapeHtml(c.label||c.key)}</th>`).join("")
  }${options.actions ? "<th>A√ß√µes</th>" : ""}</tr></thead>`;

  const tbody = `<tbody>${
    rows.map((r, idx)=>{
      return `<tr>${
        cols.map(c=>{
          const val = (typeof c.render === "function") ? c.render(r) : (r[c.key] ?? "");
          return `<td>${escapeHtml(val)}</td>`;
        }).join("")
      }${
        options.actions
        ? `<td>${options.actions(r, idx)}</td>`
        : ""
      }</tr>`;
    }).join("")
  }</tbody>`;

  tbl.innerHTML = thead + tbody;
}

function downloadCSV(filename, rows){
  if(!rows || !rows.length){ toast("Nada para exportar"); return; }
  const headers = Object.keys(rows[0]);
  const esc = (v)=>('"'+String(v??"").replaceAll('"','""')+'"');
  const csv = [headers.map(esc).join(",")].concat(
    rows.map(r => headers.map(h=>esc(r[h])).join(","))
  ).join("\n");
  const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href=url; a.download=filename;
  document.body.appendChild(a); a.click(); a.remove();
  URL.revokeObjectURL(url);
}

/*** 8) EDIT MODAL (GEN√âRICO) ***/
let editCtx = null;

function openEditModal({title, hint, fields, initial, onSave}){
  editCtx = { fields, onSave, initial: initial||{} };

  $("editTitle").textContent = title || "Editar";
  $("editHint").textContent = hint || "";

  const form = $("editForm");
  form.innerHTML = "";

  fields.forEach(f=>{
    const wrap = document.createElement("div");
    wrap.style.minWidth = f.w || "220px";
    wrap.style.flex = f.flex || "0 0 auto";

    const lab = document.createElement("div");
    lab.className = "hint";
    lab.style.fontWeight = "900";
    lab.style.marginBottom = "6px";
    lab.textContent = f.label || f.key;

    let input;
    if(f.type === "textarea"){
      input = document.createElement("textarea");
    }else if(f.type === "select"){
      input = document.createElement("select");
      (f.options||[]).forEach(opt=>{
        const o=document.createElement("option");
        o.value=opt.value; o.textContent=opt.label;
        input.appendChild(o);
      });
    }else{
      input = document.createElement("input");
      input.type = f.type || "text";
      input.className = "input";
    }
    input.classList.add("input");
    input.dataset.key = f.key;
    input.value = (initial && initial[f.key] != null) ? String(initial[f.key]) : (f.default ?? "");
    if(f.readonly) input.setAttribute("readonly","readonly");

    wrap.appendChild(lab);
    wrap.appendChild(input);
    form.appendChild(wrap);
  });

  showOverlay("overlayEdit", true);
}

function closeEditModal(){
  editCtx = null;
  showOverlay("overlayEdit", false);
}

async function saveEditModal(){
  if(!editCtx) return;

  const patch = {};
  document.querySelectorAll("#editForm .input, #editForm textarea, #editForm select").forEach(el=>{
    const k = el.dataset.key;
    if(!k) return;
    patch[k] = el.value;
  });

  try{
    $("btnEditSave").disabled = true;
    await editCtx.onSave(patch, editCtx.initial);
    closeEditModal();
  }catch(err){
    console.error(err);
    toast("Erro ao salvar");
  }finally{
    $("btnEditSave").disabled = false;
  }
}

/*** 9) API ACTIONS ***/
async function apiAtualizarRegistro(aba, campoId, valorId, patchObj){
  return callAPI({
    action:"atualizar_registro",
    key: state.key,
    aba, campoId, valorId,
    patch: JSON.stringify(patchObj)
  });
}

async function apiAlterarStatus(aba, campoId, valorId, novo){
  return callAPI({
    action:"alterar_status",
    key: state.key,
    aba, campoId, valorId,
    status: novo
  });
}

/*** 10) LOADERS (DADOS) ***/
async function testApi(){
  try{
    const r = await callAPI({ action:"loginAdmin", key: state.key });
    if(r && r.ok){
      setApiStatus(true, "API OK");
      return true;
    }
    throw r;
  }catch(err){
    setApiStatus(false, "Falha na API");
    return false;
  }
}


async function loadDashboard(force=false){
  if(state.loaded.dashboard && !force) return;

  await Promise.all([
    loadClientes(true),
    loadParceiros(true),
    loadLogs(true)
  ]);

  const clientes = state.cache.clientes;
  const parceiros = state.cache.parceiros;

  const cliAtivos = clientes.filter(c => String(c.ativo).toLowerCase()==="sim").length;
  const cliInativos = clientes.length - cliAtivos;

  const parAtivos = parceiros.filter(p => String(p.ativo).toLowerCase()==="sim").length;
  const parInativos = parceiros.length - parAtivos;

  $("mClientes").textContent = clientes.length;
  $("mClientes2").textContent = `Ativos: ${cliAtivos} | Inativos: ${cliInativos}`;

  $("mParceiros").textContent = parceiros.length;
  $("mParceiros2").textContent = `Ativos: ${parAtivos} | Inativos: ${parInativos}`;

  $("mLogs").textContent = state.cache.logs.length;
  $("mStatus").textContent = state.admin ? "Logado" : "‚Äî";

  setApiStatus(true, "API OK");
  state.loaded.dashboard = true;
}

/* ---------- CLIENTES ---------- */
async function loadClientes(force=false){
  if(state.loaded.clientes && !force) return;
  const r = await callAPI({ aba:"clientes" });
  state.cache.clientes = r.dados || [];
  state.loaded.clientes = true;
  renderClientes();
}
function renderClientes(){
  const q = ($("filtroClientes").value||"").trim().toLowerCase();
  const rows = state.cache.clientes.filter(c=>{
    if(!q) return true;
    const blob = JSON.stringify(c).toLowerCase();
    return blob.includes(q);
  });

renderTable("tblClientes", rows, [
  {key:"idPublico", label:"ID P√∫blico"},
  {key:"cpf", label:"CPF"},
  {key:"nome", label:"Nome"},
  {key:"celular", label:"Celular"},
  {key:"grupo", label:"Grupo"},
  {key:"cidade", label:"Cidade"},
  {key:"nascimento", label:"Nascimento"},
  {key:"ativo", label:"Status"},
  {key:"placa_1", label:"Placa 1"},
  {key:"modelo_1", label:"Modelo 1"},
  {key:"placa_2", label:"Placa 2"},
  {key:"modelo_2", label:"Modelo 2"},
  {key:"zap_status_enviado", label:"WhatsApp Enviado"},
],{
    actions: (c)=> {
      const ativo = String(c.ativo||"").trim().toLowerCase()==="sim";
      const cpf = c.cpf || "";
      const cpfId = apenasNumeros(cpf) || cpf; // GAS compara por n√∫meros
      return `
   <td class="acoes">
  <button onclick="alterarStatusCliente('${c.cpf}','SIM')">Ativar</button>
  <button onclick="alterarStatusCliente('${c.cpf}','NAO')">Inativar</button>
  <button onclick="editarCliente('${c.cpf}')">Editar</button>
  <button onclick="gerarTermosCliente('${c.cpf}')">Termos (PDF)</button>
</td>


      `;
    }
  });
}

async function toggleCliente(cpf, ativo){
  try{
    await apiAlterarStatus("clientes","cpf",cpf, ativo ? "NAO" : "SIM");
    toast("Status atualizado");
    await loadClientes(true);
    await loadDashboard(true);
  }catch(err){ toast("Erro ao alterar status"); }
}

function editarCliente(cpf){
  const c = state.cache.clientes.find(x => apenasNumeros(x.cpf) === apenasNumeros(cpf)) || {};
  openEditModal({
    title: "Editar cliente",
    hint: "Salva via action=atualizar_registro (aba=clientes, campoId=cpf).",
    initial: c,
    fields: [
      {key:"cpf", label:"CPF (id)", readonly:true, w:"240px"},
      {key:"nome", label:"Nome"},
      {key:"celular", label:"Celular"},
      {key:"cidade", label:"Cidade"},
      {key:"grupo", label:"Grupo"},
      {key:"nascimento", label:"Nascimento"},
      {key:"idPublico", label:"ID P√∫blico"},
      {key:"observacoes", label:"Observa√ß√µes", type:"textarea", w:"460px", flex:"1 1 460px"},
    ],
    onSave: async (patch)=>{
      // normaliza√ß√µes
      if(patch.cpf) delete patch.cpf;
      if(patch.celular) patch.celular = apenasNumeros(patch.celular);
      await apiAtualizarRegistro("clientes","cpf",cpf, patch);
      toast("Cliente atualizado");
      await loadClientes(true);
    }
  });
}

async function termosCliente(cpf){
  try{
    const r = await callAPI({ action:"gerar_termos_cliente", key: state.key, cpf });
    if(r.url) window.open(r.url, "_blank");
    else toast("PDF n√£o gerado");
  }catch(err){ toast("Erro ao gerar termos"); }
}


/* ---------- PARCEIROS ---------- */
async function loadParceiros(force=false){
  if(state.loaded.parceiros && !force) return;

  const r = await callAPI({ aba:"parceiros" });
  state.cache.parceiros = r.dados || [];

  state.loaded.parceiros = true;
  renderParceiros();
}

function renderParceiros(){
  const q = ($("filtroParceiros").value||"").trim().toLowerCase();
  const rows = state.cache.parceiros.filter(p=>{
    if(!q) return true;
    const blob = JSON.stringify(p).toLowerCase();
    return blob.includes(q);
  });

  renderTable("tblParceiros", rows, [
    {key:"nomeFantasia", label:"Nome Fantasia"},
    {key:"cnpj", label:"CNPJ"},
    {key:"cidade", label:"Cidade"},
    {key:"ramo", label:"Ramo"},
    {key:"whatsapp", label:"WhatsApp"},
    {key:"token", label:"Token"},
    {key:"ativo", label:"Status", render:(r)=> (String(r.ativo||"").toLowerCase()==="sim" ? "SIM" : "NAO") },
  ],{
    actions: (p)=>{
      const ativo = String(p.ativo||"").trim().toLowerCase()==="sim";
      const cnpj = p.cnpj || "";
      const cnpjId = apenasNumeros(cnpj) || cnpj;
      return `
        <button class="btn" onclick="toggleParceiro('${cnpjId}', ${ativo})">${ativo?'Inativar':'Ativar'}</button>
        <button class="btn" onclick="editarParceiro('${cnpjId}')">Editar</button>
        <button class="btn" onclick="contratoParceiro('${cnpjId}')">Contrato (PDF)</button>
      `;
    }
  });
}

async function toggleParceiro(cnpj, ativo){
  try{
    await apiAlterarStatus("parceiros","cnpj",cnpj, ativo ? "NAO" : "SIM");
    toast("Status atualizado");
    await loadParceiros(true);
    await loadDashboard(true);
  }catch(err){ toast("Erro ao alterar status"); }
}

function editarParceiro(cnpj){
  const p = state.cache.parceiros.find(x => apenasNumeros(x.cnpj) === apenasNumeros(cnpj)) || {};
  openEditModal({
    title: "Editar parceiro",
    hint: "Salva via action=atualizar_parceiro (patch) + action=alterar_status quando necess√°rio.",
    initial: p,
    fields: [
      {key:"cnpj", label:"CNPJ (id)", readonly:true, w:"260px"},
      {key:"nomeFantasia", label:"Nome Fantasia"},
      {key:"cidade", label:"Cidade"},
      {key:"ramo", label:"Ramo"},
      {key:"whatsapp", label:"WhatsApp"},
      {key:"instagram", label:"Instagram"},
      {key:"site", label:"Site"},
      {key:"email", label:"Email"},
      {key:"logoURL", label:"Logo URL", w:"420px", flex:"1 1 420px"},
      {key:"contato", label:"Contato"},
    ],
    onSave: async (patch)=>{
      delete patch.cnpj;
      if(patch.whatsapp) patch.whatsapp = apenasNumeros(patch.whatsapp);
      // sua fun√ß√£o atualizar_parceiro aplica patch por cabe√ßalho
      await callAPI({
        action:"atualizar_parceiro",
        key: state.key,
        cnpj,
        patch: JSON.stringify(patch)
      });
      toast("Parceiro atualizado");
      await loadParceiros(true);
    }
  });
}

function novoParceiro(){
  openEditModal({
    title: "Criar parceiro",
    hint: "Cria parceiro e gera token autom√°tico.",
    initial: {},
    fields: [
      {key:"cnpj", label:"CNPJ", w:"260px"},
      {key:"nomeFantasia", label:"Nome Fantasia"},
      {key:"cidade", label:"Cidade"},
      {key:"ramo", label:"Ramo"},
      {key:"whatsapp", label:"WhatsApp"},
      {key:"instagram", label:"Instagram"},
      {key:"site", label:"Site"},
      {key:"email", label:"Email"},
      {key:"logoURL", label:"Logo URL", w:"420px", flex:"1 1 420px"},
      {key:"contato", label:"Contato"},
    ],
    onSave: async (data)=>{
      const cnpj = apenasNumeros(data.cnpj);
      if(cnpj.length !== 14) throw new Error("CNPJ_INVALIDO");
      const r = await callAPI({
        action:"criar_parceiro",
        key: state.key,
        cnpj,
        nomeFantasia: data.nomeFantasia||"",
        cidade: data.cidade||"",
        ramo: data.ramo||"",
        whatsapp: apenasNumeros(data.whatsapp||""),
        instagram: data.instagram||"",
        site: data.site||"",
        email: data.email||"",
        logoURL: data.logoURL||"",
        contato: data.contato||""
      });
      toast("Parceiro criado. Token: " + (r.token||""));
      await loadParceiros(true);
      await loadDashboard(true);
    }
  });
}

async function contratoParceiro(cnpj){
  try{
    const r = await callAPI({ action:"gerarContrato", key: state.key, cnpj });
    if(r.url) window.open(r.url, "_blank");
    else toast("PDF n√£o gerado");
  }catch(err){ toast("Erro ao gerar contrato"); }
}

/* ---------- BENEF√çCIOS ---------- */
async function loadBeneficios(force=false){
  if(state.loaded.beneficios && !force) return;
  const r = await callAPI({ aba:"beneficios" });
  state.cache.beneficios = r.dados || [];
  state.loaded.beneficios = true;
  renderBeneficios();
}
function renderBeneficios(){
  const q = ($("filtroBeneficios").value||"").trim().toLowerCase();
  const rows = state.cache.beneficios.filter(b=>{
    if(!q) return true;
    const blob = JSON.stringify(b).toLowerCase();
    return blob.includes(q);
  });

  renderTable("tblBeneficios", rows, [
    {key:"parceiro", label:"Parceiro"},
    {key:"grupo", label:"Grupo"},
    {key:"descricao", label:"Descri√ß√£o"},
    {key:"regra", label:"Regra"},
    {key:"ativo", label:"Status", render:(r)=> (String(r.ativo||"").toLowerCase()==="sim" ? "SIM" : "NAO") },
  ],{
    actions: (b)=>{
      const ativo = String(b.ativo||"").trim().toLowerCase()==="sim";
      const id = (b.descricao || "").trim();
      return `
        <button class="btn" onclick="toggleBeneficio('${escapeJs(id)}', ${ativo})">${ativo?'Inativar':'Ativar'}</button>
        <button class="btn" onclick="editarBeneficio('${escapeJs(id)}')">Editar</button>
      `;
    }
  });
}
function escapeJs(s){
  return String(s??"").replaceAll("\\","\\\\").replaceAll("'","\\'");
}
async function toggleBeneficio(descricao, ativo){
  try{
    await apiAlterarStatus("beneficios","descricao",descricao, ativo ? "NAO" : "SIM");
    toast("Status atualizado");
    await loadBeneficios(true);
  }catch(err){ toast("Erro ao alterar status"); }
}
function editarBeneficio(descricao){
  const b = state.cache.beneficios.find(x => String(x.descricao||"").trim() === String(descricao||"").trim()) || {};
  openEditModal({
    title:"Editar benef√≠cio",
    hint:"Identificador usado: descricao (precisa existir e bater exatamente).",
    initial: b,
    fields:[
      {key:"descricao", label:"Descri√ß√£o (id)", readonly:true, w:"520px", flex:"1 1 520px"},
      {key:"parceiro", label:"Parceiro"},
      {key:"grupo", label:"Grupo"},
      {key:"regra", label:"Regra", type:"textarea", w:"520px", flex:"1 1 520px"},
    ],
    onSave: async (patch)=>{
      delete patch.descricao;
      await apiAtualizarRegistro("beneficios","descricao",descricao, patch);
      toast("Benef√≠cio atualizado");
      await loadBeneficios(true);
    }
  });
}
function novoBeneficio(){
  openEditModal({
    title:"Criar benef√≠cio",
    hint:"Cria via action=criar_beneficio.",
    initial:{},
    fields:[
      {key:"parceiro", label:"Parceiro"},
      {key:"grupo", label:"Grupo"},
      {key:"descricao", label:"Descri√ß√£o", w:"520px", flex:"1 1 520px"},
      {key:"regra", label:"Regra", type:"textarea", w:"520px", flex:"1 1 520px"},
    ],
    onSave: async (data)=>{
      if(!data.descricao) throw new Error("DESCRICAO_OBRIGATORIA");
      await callAPI({
        action:"criar_beneficio",
        key: state.key,
        parceiro: data.parceiro||"",
        grupo: data.grupo||"",
        descricao: data.descricao||"",
        regra: data.regra||""
      });
      toast("Benef√≠cio criado");
      await loadBeneficios(true);
    }
  });
}

/* ---------- PROMO√á√ïES ---------- */
async function loadPromocoes(force=false){
  if(state.loaded.promocoes && !force) return;
  const r = await callAPI({ aba:"promocoes" });
  state.cache.promocoes = r.dados || [];
  state.loaded.promocoes = true;
  renderPromocoes();
}
function renderPromocoes(){
  const q = ($("filtroPromocoes").value||"").trim().toLowerCase();
  const rows = state.cache.promocoes.filter(p=>{
    if(!q) return true;
    const blob = JSON.stringify(p).toLowerCase();
    return blob.includes(q);
  });

  renderTable("tblPromocoes", rows, [
    {key:"parceiro", label:"Parceiro"},
    {key:"titulo", label:"T√≠tulo"},
    {key:"descricao", label:"Descri√ß√£o"},
    {key:"inicio", label:"In√≠cio"},
    {key:"fim", label:"Fim"},
    {key:"ativo", label:"Status", render:(r)=> (String(r.ativo||"").toLowerCase()==="sim" ? "SIM" : "NAO") },
  ],{
    actions: (p)=>{
      const ativo = String(p.ativo||"").trim().toLowerCase()==="sim";
      const id = (p.titulo || "").trim();
      return `
        <button class="btn" onclick="togglePromocao('${escapeJs(id)}', ${ativo})">${ativo?'Inativar':'Ativar'}</button>
        <button class="btn" onclick="editarPromocao('${escapeJs(id)}')">Editar</button>
      `;
    }
  });
}
async function togglePromocao(titulo, ativo){
  try{
    await apiAlterarStatus("promocoes","titulo",titulo, ativo ? "NAO" : "SIM");
    toast("Status atualizado");
    await loadPromocoes(true);
  }catch(err){ toast("Erro ao alterar status"); }
}
function editarPromocao(titulo){
  const p = state.cache.promocoes.find(x => String(x.titulo||"").trim() === String(titulo||"").trim()) || {};
  openEditModal({
    title:"Editar promo√ß√£o",
    hint:"Identificador usado: titulo (precisa existir e bater exatamente).",
    initial:p,
    fields:[
      {key:"titulo", label:"T√≠tulo (id)", readonly:true, w:"520px", flex:"1 1 520px"},
      {key:"parceiro", label:"Parceiro"},
      {key:"descricao", label:"Descri√ß√£o", type:"textarea", w:"520px", flex:"1 1 520px"},
      {key:"inicio", label:"In√≠cio"},
      {key:"fim", label:"Fim"},
    ],
    onSave: async (patch)=>{
      delete patch.titulo;
      await apiAtualizarRegistro("promocoes","titulo",titulo, patch);
      toast("Promo√ß√£o atualizada");
      await loadPromocoes(true);
    }
  });
}
function novoPromocao(){
  openEditModal({
    title:"Criar promo√ß√£o",
    hint:"Cria via action=criar_promocao.",
    initial:{},
    fields:[
      {key:"parceiro", label:"Parceiro"},
      {key:"titulo", label:"T√≠tulo"},
      {key:"descricao", label:"Descri√ß√£o", type:"textarea", w:"520px", flex:"1 1 520px"},
      {key:"inicio", label:"In√≠cio (YYYY-MM-DD)"},
      {key:"fim", label:"Fim (YYYY-MM-DD)"},
    ],
    onSave: async (data)=>{
      if(!data.titulo) throw new Error("TITULO_OBRIGATORIO");
      await callAPI({
        action:"criar_promocao",
        key: state.key,
        parceiro: data.parceiro||"",
        titulo: data.titulo||"",
        descricao: data.descricao||"",
        inicio: data.inicio||"",
        fim: data.fim||""
      });
      toast("Promo√ß√£o criada");
      await loadPromocoes(true);
    }
  });
}

/* ---------- LOGS / LOG_ADMIN / ADMINS ---------- */
async function loadLogs(force=false){
  if(state.loaded.logs && !force) return;
  const r = await callAPI({ aba:"logs" });
  state.cache.logs = r.dados || [];
  state.loaded.logs = true;
  renderLogs();
}
function renderLogs(){
  const q = ($("filtroLogs").value||"").trim().toLowerCase();
  const rows = state.cache.logs
    .slice().reverse()
    .filter(l => !q ? true : JSON.stringify(l).toLowerCase().includes(q))
    .slice(0, 500);

  renderTable("tblLogs", rows, [
    {key:"data", label:"Data", render:(r)=>formatarDataBR(r.data)},

    {key:"cpf", label:"CPF"},
    {key:"nome", label:"Nome"},
    {key:"parceiro", label:"Parceiro"},
    {key:"codigoERO", label:"C√≥digo", render:(r)=> r.codigoERO || r["codigo-ero"] || "" },
    {key:"status", label:"Status"},
    {key:"tipoValidacao", label:"Tipo"},
  ]);
}

async function loadLogAdmin(force=false){
  if(state.loaded.log_admin && !force) return;
  const r = await callAPI({ aba:"log_admin" });
  state.cache.log_admin = r.dados || [];
  state.loaded.log_admin = true;
  renderLogAdmin();
}
function renderLogAdmin(){
  const q = ($("filtroLogAdmin").value||"").trim().toLowerCase();
  const rows = state.cache.log_admin
    .slice().reverse()
    .filter(l => !q ? true : JSON.stringify(l).toLowerCase().includes(q))
    .slice(0, 500);

  renderTable("tblLogAdmin", rows, [
    {key:"data", label:"Data", render:(r)=>formatarDataBR(r.data)},

    {key:"admin", label:"Admin"},
    {key:"acao", label:"A√ß√£o"},
    {key:"entidade", label:"Entidade"},
    {key:"id", label:"ID"},
    {key:"detalhes", label:"Detalhes"},
  ]);
}

async function loadAdmins(force=false){
  if(state.loaded.admins && !force) return;
  const r = await callAPI({ aba:"admins" });
  state.cache.admins = r.dados || [];
  state.loaded.admins = true;
  renderAdmins();
}
function renderAdmins(){
  const q = ($("filtroAdmins").value||"").trim().toLowerCase();
  const rows = state.cache.admins.filter(a=>{
    if(!q) return true;
    return JSON.stringify(a).toLowerCase().includes(q);
  });
  renderTable("tblAdmins", rows, [
    {key:"usuario", label:"Usu√°rio"},
    {key:"senha", label:"Senha"},
    {key:"nome", label:"Nome"},
    {key:"ativo", label:"Ativo"},
  ]);
}

/*** 11) WIRES (EVENTS) ***/
function bind(){

  const d = new Date();
  $("ultima").textContent =
    `${String(d.getMonth()+1).padStart(2,"0")}/${d.getFullYear()}`;

  $("btnTestarApi").addEventListener("click", ()=>loadDashboard(true));

  $("btnCarregarTudo").addEventListener("click", async ()=>{
    if(!(await ensureLogin())) return;

    toast("Carregando relat√≥rio...");
    await Promise.allSettled([
      loadDashboard(true),
      loadClientes(true),
      loadParceiros(true),
      loadBeneficios(true),
      loadPromocoes(true),
      loadLogs(true),
      loadLogAdmin(true)
    ]);
    toast("Relat√≥rio carregado");
    showView("logs");
  });

  document.querySelectorAll(".navbtn").forEach(b=>{
    b.addEventListener("click", ()=>showView(b.dataset.view));
  });

  $("btnLogin").addEventListener("click", async ()=>{
    const key = ($("inpKey").value||"").trim();
    if(!key) return;
    state.key = key;
    $("loginMsg").textContent = "Verificando...";
    if(await ensureLogin()){
      toast("Bem-vindo, " + state.admin);
      showView("dashboard");
    }
  });

  $("inpKey").addEventListener("keydown", e=>{
    if(e.key==="Enter") $("btnLogin").click();
  });

  $("btnEditClose")?.addEventListener("click", closeEditModal);
  $("btnEditCancel")?.addEventListener("click", closeEditModal);
  $("btnEditSave")?.addEventListener("click", saveEditModal);

  $("filtroClientes").addEventListener("input", renderClientes);
  $("filtroParceiros").addEventListener("input", renderParceiros);
  $("filtroBeneficios").addEventListener("input", renderBeneficios);
  $("filtroPromocoes").addEventListener("input", renderPromocoes);
  $("filtroLogs").addEventListener("input", renderLogs);
  $("filtroLogAdmin").addEventListener("input", renderLogAdmin);
  $("filtroAdmins").addEventListener("input", renderAdmins);

  $("btnReloadClientes").addEventListener("click", ()=>loadClientes(true));
  $("btnReloadParceiros").addEventListener("click", ()=>loadParceiros(true));
  $("btnNovoParceiro").addEventListener("click", novoParceiro);

  $("btnReloadBeneficios").addEventListener("click", ()=>loadBeneficios(true));
  $("btnNovoBeneficio").addEventListener("click", novoBeneficio);

  $("btnReloadPromocoes").addEventListener("click", ()=>loadPromocoes(true));
  $("btnNovoPromocao").addEventListener("click", novoPromocao);

  $("btnReloadLogs").addEventListener("click", ()=>loadLogs(true));
  $("btnReloadLogAdmin").addEventListener("click", ()=>loadLogAdmin(true));
  $("btnReloadAdmins").addEventListener("click", ()=>loadAdmins(true));
}
function getCurrentViewName(){
  const active = document.querySelector(".navbtn.active");
  return active ? active.dataset.view : "dashboard";
}

function mapearPorCabecalho(headers, row) {
  const obj = {};
  headers.forEach((h, i) => {
    obj[h.trim()] = row[i] ?? "";
  });
  return obj;
}
function getQueryParam(nome) {
  const params = new URLSearchParams(window.location.search);
  return params.get(nome);
}

// uso
const idPublico = getQueryParam("idPublico");
const parceiroId = getQueryParam("parceiro");

function formatarDataBR(data) {
  if (!data) return '';
  const d = new Date(data);
  return d.toLocaleDateString('pt-BR');
}
function openLoginModal(){
  const el = document.getElementById("overlayLogin");
  if(el) el.classList.add("show");
}
function closeLoginModal(){
  const el = document.getElementById("overlayLogin");
  if(el) el.classList.remove("show");
}
// deixa as fun√ß√µes vis√≠veis para onclick=""
window.alterarStatusCliente = async function(cpf, status){
  try{
    if(!(await ensureLogin())) return;

    await callAPI({
      action: "alterar_status",
      aba: "clientes",
      campoId: "cpf",
      valorId: cpf,
      status: status
    });

    toast("‚úÖ Status atualizado");
    await loadClientes(true);
    await loadDashboard(true);

  }catch(err){
    console.error(err);
    toast("‚ùå Erro ao atualizar status");
  }
};

/*** 12) START (SAFE) ***/
 
  /* =========================
   START LIMPO (SAFE MODE)
========================= */

document.addEventListener("DOMContentLoaded", async ()=>{
  try{
    bind();

    const ok = await ensureLogin();
    showView("dashboard");

    if(ok){
      loadDashboard(true);
    }else{
      openLoginModal();
    }

  }catch(err){
    console.error("ERRO FATAL:", err);
    alert("Erro cr√≠tico no admin.html. Veja o console.");
  }
});
</script>
<div class="toast" id="toast"></div>
<script>
function gerarContratoParceiro(parceiroId) {
  const url = API_URL + "?action=gerarContratoParceiro&parceiro_id=" + parceiroId;

  fetch(url)
    .then(r => r.json())
    .then(resp => {
      if (resp.ok && resp.pdfUrl) {
        window.open(resp.pdfUrl, "_blank");
      } else {
        alert("PDF n√£o gerado");
      }
    })
    .catch(err => {
      console.error(err);
      alert("Erro ao gerar contrato");
    });
}
</script>

</body>
</html>
