<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>App de Valida√ß√£o ‚Ä¢ Cart√£o AproveitAI</title>

<link rel="apple-touch-icon" href="logo-aproveitai.png">
<meta name="theme-color" content="#0a7a2a">

<script src="https://unpkg.com/html5-qrcode"></script>

<style>
body{margin:0;font-family:Arial,Helvetica,sans-serif;background:#bfefff}
header{background:#fff;padding:10px;box-shadow:0 2px 5px rgba(0,0,0,.1)}
.brand{display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap}
.logo{max-height:90px}
.center{text-align:center;flex:1}
h1{margin:0;color:#0a7a2a}
.slogan{margin:4px 0;color:#555;font-style:italic}
.tagline{background:#dfffe0;padding:8px;border-radius:8px;font-weight:bold;display:inline-block}

.warn{background:#fff3cd;padding:8px;text-align:center;font-size:13px}

.container{max-width:980px;margin:auto;padding:16px}
.grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
@media(max-width:800px){.grid{grid-template-columns:1fr}}

.card{background:#fff;border-radius:14px;padding:16px;box-shadow:0 8px 20px rgba(0,0,0,.1)}
.card h2{margin-top:0;color:#0a7a2a}

input{width:100%;padding:14px;border-radius:10px;border:1px solid #ccc;font-size:16px}
.row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
@media(max-width:500px){.row{grid-template-columns:1fr}}

button{padding:14px;border-radius:10px;border:none;font-size:16px;font-weight:bold;cursor:pointer}
.btn-ok{background:#128c4a;color:#fff}
.btn-soft{background:#eaf6ef;color:#0a7a2a}
.btn-out{background:#b42318;color:#fff}

#resultado{margin-top:12px}
.ok{background:#e9f8ef;border:2px solid #0a7a2a;padding:14px;border-radius:12px}
.no{background:#ffecec;border:2px solid #b42318;padding:14px;border-radius:12px}

.badge{display:inline-block;padding:6px 10px;border-radius:999px;font-size:12px;font-weight:bold;background:#eef7f0;color:#0a7a2a}

.big{margin-top:10px;padding:12px;border-radius:12px;border:2px dashed #0a7a2a;font-size:18px;font-weight:bold;text-align:center}

footer{background:#dfffe0;padding:12px;text-align:center;font-size:12px}
</style>
</head>

<body>

<header>
  <div class="brand">
    <img src="logo-prometheus.png" class="logo">
    <div class="center">
      <h1>Cart√£o AproveitAI</h1>
      <div class="slogan">Tecnologia com Consci√™ncIA gera Resultado.</div>
      <div class="tagline">üîí APP DE VALIDA√á√ÉO ‚Äì Parceiros</div>
      <div id="parceiroInfo"></div>
    </div>
    <img src="logo-aproveitai.png" class="logo">
  </div>
</header>

<div class="warn">
‚ö†Ô∏è Valida√ß√£o exclusiva para parceiros. Logs gravam CNPJ e c√≥digo de autoriza√ß√£o.
</div>

<main class="container">
<div class="grid">

<!-- VALIDAR -->
<div class="card">
<h2>üìã Validar Cliente</h2>

<div class="row">
<input id="cpf" placeholder="CPF (opcional)">
<input id="idPublico" placeholder="ID P√∫blico (APV-XXXX)">
</div>

<div class="row" style="margin-top:10px">
<button class="btn-soft" onclick="abrirQr()">üì∑ Ler QR</button>
<button class="btn-ok" onclick="validar()">VALIDAR</button>
</div>

<div id="qrBox" style="display:none;margin-top:10px">
<div id="qr-reader"></div>
<button class="btn-out" style="margin-top:8px" onclick="fecharQr()">Fechar c√¢mera</button>
</div>

<div id="resultado"></div>

<button class="btn-soft" style="margin-top:12px" onclick="sair()">üö™ Sair</button>
</div>

<!-- PARCEIRO -->
<div class="card">
<h2>üè™ Parceiro logado</h2>
<div class="badge" id="nomeParceiro">-</div>
<div class="badge" id="cnpjParceiro">-</div>
<div style="margin-top:10px;font-size:13px">
Este app n√£o permite valida√ß√£o p√∫blica.
</div>
</div>

</div>
</main>

<footer>
¬© 2025 Cart√£o AproveitAI ‚Ä¢ PROMETHEUS EROPRO<br>
Descontos e benef√≠cios s√£o definidos pelos parceiros.
</footer>

<script>
/* ================= CONFIG ================= */
const API_URL = "https://script.google.com/macros/s/AKfycbzhwXhtWdsDSuABRneoz6QAD1SxpnMq3vc8e1FhtknlB7_1j6qLjYIbPA0qPJS7ck7y/exec";

/* ============ SESS√ÉO ============ */
const parceiroNome  = localStorage.getItem("app_parceiro_nome");
const parceiroCNPJ  = localStorage.getItem("app_parceiro_cnpj");
const parceiroToken = localStorage.getItem("app_token");

if(!parceiroNome || !parceiroCNPJ || !parceiroToken){
  alert("Sess√£o expirada. Fa√ßa login novamente.");
  location.href="login-app.html";
}

document.getElementById("nomeParceiro").innerText = parceiroNome;
document.getElementById("cnpjParceiro").innerText = "CNPJ: "+parceiroCNPJ;
document.getElementById("parceiroInfo").innerText =
  "Parceiro logado: "+parceiroNome+" ‚Ä¢ "+parceiroCNPJ;

/* ============ HELPERS ============ */
function num(v){return String(v||"").replace(/\D/g,"")}
function jsonp(url){
  return new Promise((ok,err)=>{
    const cb="cb_"+Date.now();
    window[cb]=d=>{delete window[cb];s.remove();ok(d)};
    const s=document.createElement("script");
    s.src=url+"&callback="+cb;
    s.onerror=()=>err();
    document.body.appendChild(s);
  });
}

/* ============ VALIDAR ============ */
async function validar(){
  const cpf=num(cpfEl.value);
  const id=idPublico.value.trim();
  if(!cpf && !id){alert("Informe CPF ou ID.");return}

  const p=new URLSearchParams();
  if(cpf)p.set("cpf",cpf);
  if(id)p.set("idPublico",id);

  p.set("acao","validarApp");
  p.set("parceiro",parceiroNome);
  p.set("cnpj_parceiro",parceiroCNPJ);
  p.set("token",parceiroToken);
  p.set("origem","app_validacao");

  try{
    const d=await jsonp(API_URL+"?"+p.toString());
    mostrar(d);
  }catch{
    mostrar({erro:"Falha na API"});
  }
}

function mostrar(d){
  const el=resultado;
  if(d.erro){el.innerHTML=`<div class="no">${d.erro}</div>`;return}
  const ativo=String(d.ativo).toUpperCase()==="SIM";
  el.innerHTML=`
  <div class="${ativo?"ok":"no"}">
    <b>${d.nome||"-"}</b><br>
    Status: ${ativo?"ATIVO":"INATIVO"}<br>
    CPF: ${d.cpf||"-"}<br>
    Grupo: ${d.grupo||"-"}
    ${ativo&&d.codigoERO?`<div class="big">${d.codigoERO}</div>`:""}
  </div>`;
}

/* ============ QR ============ */
let qr=null;
async function abrirQr(){
  qrBox.style.display="block";
  qr=new Html5Qrcode("qr-reader");
  await qr.start({facingMode:"environment"},{fps:10,qrbox:250},t=>{
    if(num(t).length===11)cpfEl.value=num(t);
    else idPublico.value=t;
    fecharQr(); validar();
  });
}
async function fecharQr(){
  if(qr){await qr.stop();await qr.clear();qr=null}
  qrBox.style.display="none";
}

/* ============ SAIR ============ */
function sair(){
  localStorage.clear();
  location.href="login-app.html";
}

const cpfEl=document.getElementById("cpf");
const idPublico=document.getElementById("idPublico");
</script>

</body>
</html>
