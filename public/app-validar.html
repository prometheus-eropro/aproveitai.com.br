<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>App Valida√ß√£o ‚Ä¢ Cart√£o AproveitAI</title>

  <link rel="apple-touch-icon" href="logo-aproveitai.png">
  <meta name="theme-color" content="#0a7a2a">

  <!-- Leitor de QR -->
  <script src="https://unpkg.com/html5-qrcode" defer></script>

  <style>
    body{
      margin:0;
      font-family:'Segoe UI', Arial, sans-serif;
      background:#bfefff;
    }

    /* =========================
       CABE√áALHO (IGUAL AO cartao.html)
    ========================= */
    .site-header {
      background: white;
      padding: 10px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .brandline {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 15px;
      flex-wrap: wrap;
    }
    .logo {
      max-height: 180px;
      height: auto;
      width: auto;
      object-fit: contain;
    }
    .brand-center {
      flex: 1;
      text-align: center;
    }
    .site-title {
      font-size: 36px;
      color: #0a7a2a;
      text-shadow: 1px 1px 3px rgba(0,0,0,0.3);
      font-weight: bold;
      margin: 0;
    }
    .slogan {
      font-size: 16px;
      font-style: italic;
      margin: 6px 0 0;
      color: #555;
    }
    .boas-vindas {
      background: #dfffe0;
      padding: 12px 15px;
      border-radius: 8px;
      margin-top: 10px;
      font-size: 16px;
      line-height: 1.5;
      font-weight: 600;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
      display:inline-block;
    }

    .warningbar{
      background:#fff3cd;
      color:#856404;
      padding:8px;
      text-align:center;
      font-size:13px;
    }

    /* =========================
       CONTE√öDO (APP)
    ========================= */
    .container{
      max-width: 980px;
      margin: 0 auto;
      padding: 18px 12px 28px;
    }

    .grid-app{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
      align-items: start;
    }
    @media(max-width: 900px){
      .grid-app{ grid-template-columns: 1fr; }
    }

    .card{
      background:#fff;
      border-radius:14px;
      padding:18px;
      box-shadow:0 10px 25px rgba(0,0,0,.10);
    }

    .card h2{
      margin:0 0 10px 0;
      font-size:18px;
      color:#0a7a2a;
    }

    .hint{
      font-size:13px;
      color:#245;
      margin-top:6px;
    }

    .field{
      width:100%;
      padding:14px 16px;
      border:1px solid #d9d9d9;
      border-radius:10px;
      font-size:16px;
      box-sizing:border-box;
      outline:none;
    }
    .field:focus{
      border-color:#0a7a2a;
      box-shadow:0 0 0 3px rgba(10,122,42,.12);
    }

    .row{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    @media(max-width: 520px){
      .row{ grid-template-columns: 1fr; }
    }

    .btn{
      padding:14px 16px;
      border:none;
      border-radius:10px;
      font-size:16px;
      cursor:pointer;
      font-weight:700;
    }
    .btn-primary{ background:#128c4a; color:#fff; }
    .btn-ghost{ background:#eef7f0; color:#0f6f3a; }
    .btn-danger{ background:#b42318; color:#fff; }

    .result{
      margin-top:14px;
      padding:14px;
      border-radius:12px;
      border:2px solid transparent;
    }
    .result.ok{ background:#e9f8ef; border-color:#0f6f3a; }
    .result.no{ background:#ffecec; border-color:#b42318; }

    #qrArea{ display:none; margin-top:12px; }
    #qr-reader{ width:100%; max-width:480px; margin-top:10px; }

    .badge{
      display:inline-block;
      padding:6px 10px;
      border-radius:999px;
      font-size:12px;
      font-weight:800;
      letter-spacing:.3px;
      background:#eef7f0;
      color:#0f6f3a;
    }

    .status-pill{
      display:inline-block;
      padding:6px 10px;
      border-radius:999px;
      font-size:12px;
      font-weight:900;
      letter-spacing:.4px;
      margin-top:8px;
    }
    .status-ok{ background:#e9f8ef; color:#0f6f3a; border:1px solid #0f6f3a; }
    .status-no{ background:#ffecec; color:#b42318; border:1px solid #b42318; }

    .bigcode{
      margin-top:10px;
      padding:12px;
      border-radius:12px;
      background:#f7fff9;
      border:1px dashed #0a7a2a;
      font-size:18px;
      font-weight:900;
      letter-spacing:.6px;
      text-align:center;
    }

    /* =========================
       RODAP√â (IGUAL AO cartao.html)
    ========================= */
    footer{
      background:#dfffe0;
      padding:12px;
      text-align:center;
      font-size:12px;
      line-height:1.4;
      border-top: 3px solid white;
    }
  </style>
</head>

<body>

<!-- ‚úÖ CABE√áALHO PADRONIZADO -->
<header class="site-header">
  <div class="brandline">
    <img src="logo-prometheus.png" class="logo logo-prometheus" alt="Prometheus EROPRO">
    <div class="brand-center">
      <h1 class="site-title">Cart√£o AproveitAI</h1>
      <p class="slogan">Tecnologia com Consci√™ncIA gera Resultado.</p>
      <p class="boas-vindas">
        üîí <strong>APP DE VALIDA√á√ÉO</strong><br>
        Exclusivo para parceiros (QR / CPF / ID).
      </p>
      <div class="hint" id="parceiroInfo"></div>
    </div>
    <img src="logo-aproveitai.png" class="logo logo-aproveitai" alt="AproveitAI">
  </div>
</header>

<div class="warningbar">
  ‚ö†Ô∏è Este app √© exclusivo para parceiros. A valida√ß√£o gera log com CNPJ e pode emitir autoriza√ß√£o somente se o cliente estiver ATIVO.
</div>

<main class="container">
  <div class="grid-app">

    <!-- BLOCO 1: VALIDA√á√ÉO -->
    <section class="card">
      <h2>üìã Validar Cliente</h2>

      <div class="row">
        <input id="cpf" class="field" inputmode="numeric" placeholder="CPF do cliente (opcional)">
        <input id="idPublico" class="field" placeholder="ID P√∫blico (APV-XXXXXX) (opcional)">
      </div>

      <div class="row" style="margin-top:12px;">
        <button class="btn btn-ghost" id="btnQr" type="button">üì∑ Ler QR Code</button>
        <button class="btn btn-primary" id="btnValidar" type="button">VALIDAR CLIENTE</button>
      </div>

      <div id="qrArea">
        <div style="display:flex; gap:10px; flex-wrap:wrap;">
          <button class="btn btn-danger" id="btnFecharQr" type="button">Fechar c√¢mera</button>
          <span class="hint" style="align-self:center;">Aponte para o QR do cart√£o.</span>
        </div>
        <div id="qr-reader"></div>
      </div>

      <div id="resultado"></div>

      <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:14px;">
                <button class="btn btn-ghost" id="btnSair" type="button">üö™ Sair</button>
    </div>

      <div class="hint" style="margin-top:10px;">
        Dica: para QR e login funcionarem no celular, publique em HTTPS (Vercel). Abrir via <b>file://</b> pode bloquear storage e c√¢mera.
      </div>
    </section>

    <!-- BLOCO 2: PAINEL DO PARCEIRO (RESUMO) -->
    <section class="card">
      <h2>üè™ Parceiro logado</h2>
      <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
        <span class="badge" id="pnomeFantasia">Parceiro</span>
        <span class="badge" id="pCnpj">CNPJ: -</span>
      </div>

      <div class="hint" style="margin-top:10px;">
        Este app <b>n√£o</b> permite valida√ß√£o p√∫blica. Toda consulta exige token do parceiro e grava logs.
      </div>

      <div class="hint" style="margin-top:10px;">
        <b>√öltima atualiza√ß√£o:</b> 01/2026.
      </div>
    </section>

  </div>
</main>

<!-- ‚úÖ RODAP√â PADR√ÉO -->
<footer>
  ¬© 2025 Cart√£o AproveitAI ‚Ä¢ PROMETHEUS EROPRO<br>
  <strong>Aviso legal:</strong> O Cart√£o AproveitAI n√£o garante descontos.
  Benef√≠cios e promo√ß√µes s√£o definidos e concedidos exclusivamente pelos parceiros,
  v√°lidos, em regra, para pagamentos √† vista em moeda corrente, salvo autoriza√ß√£o expressa do estabelecimento.
</footer>

<script>
  // ====== CONFIGURE A URL DO SEU APPS SCRIPT (MESMA DO SITE) ======
  const API_URL = "https://script.google.com/macros/s/AKfycbzhwXhtWdsDSuABRneoz6QAD1SxpnMq3vc8e1FhtknlB7_1j6qLjYIbPA0qPJS7ck7y/exec";

/* ===============================
   CONTROLE DE PARCEIRO LOGADO
================================ */
// ===============================
// SESS√ÉO DO PARCEIRO (PADR√ÉO √öNICO)
// ===============================
const parceiroNome = localStorage.getItem("app_parceiro_nome");
const parceiroCNPJ = localStorage.getItem("app_parceiro_cnpj");
const parceiroToken = localStorage.getItem("app_token");

if (!parceiroNome || !parceiroCNPJ || !parceiroToken) {
  alert("Acesso restrito a parceiros. Fa√ßa login novamente.");
  window.location.href = "login-app.html";
  throw new Error("Parceiro n√£o logado");
}
if (!parceiroNome || !parceiroCNPJ || !parceiroToken) {
  alert("Acesso restrito a parceiros. Fa√ßa login novamente.");
  window.location.href = "login-app.html";
  throw new Error("Parceiro n√£o logado");
}

document.getElementById("parceiroInfo").innerText =
  "Parceiro logado: " + parceiroNome + " ‚Ä¢ CNPJ: " + parceiroCNPJ;

document.getElementById("pnomeFantasia").innerText = parceiroNome;
document.getElementById("pCnpj").innerText = "CNPJ: " + parceiroCNPJ;


  function apenasNumeros(v){ return String(v||"").replace(/\D/g,""); }

  // ====== SESS√ÉO DO APP (token-app salvo no login) ======
  // ===== JSONP helper =====
  function jsonp(url){
    return new Promise((resolve, reject) => {
      const cbName = "cb_" + Date.now() + "_" + Math.random().toString(16).slice(2);
      const s = document.createElement("script");
      window[cbName] = (data) => {
        cleanup();
        resolve(data);
      };
      s.src = url + (url.includes("?") ? "&" : "?") + "callback=" + cbName;
      s.onerror = () => { cleanup(); reject(new Error("JSONP_FAIL")); };
      document.body.appendChild(s);

      function cleanup(){
        try{ delete window[cbName]; }catch(e){ window[cbName]=undefined; }
        if(s && s.parentNode) s.parentNode.removeChild(s);
      }
    });
  }

  function mostrarResultado(data){
   
const ativo = String(data.ativo || "").toUpperCase() === "SIM";
 const el = document.getElementById("resultado");

    if(!data || data.erro){
      el.innerHTML = `
        <div class="result no">
          <b>Erro:</b> ${data && data.erro ? data.erro : "Falha na consulta"}
        </div>
      `;
      return;
    }


    el.innerHTML = `
      <div class="result ${ativo ? "ok" : "no"}">
        <div style="font-size:18px; font-weight:900;">${data.nome || "-"}</div>
        <div class="status-pill ${ativo ? "status-ok":"status-no"}">
          ${ativo ? "ATIVO" : "INATIVO"}
        </div>

        <div style="margin-top:10px;">
          <div><b>CPF:</b> ${mesclarCPF(data.cpf)}</div>
          <div><b>ID P√∫blico:</b> ${data.idPublico || "-"}</div>
          <div><b>Grupo:</b> ${data.grupo || "-"}</div>
          <div><b>Cidade:</b> ${data.cidade || "-"}</div>
<div><b>Cadastro:</b> ${data.dataCadastro || "-"}</div>
        
</div>

        ${data.mensagemStatus ? `<div style="margin-top:10px; font-size:15px;">${data.mensagemStatus}</div>` : ""}

        ${ativo && data.codigoERO ? `<div class="bigcode">C√ìDIGO: ${data.codigoERO}</div>` : ""}
      </div>
    `;
  }

  // ‚úÖ VALIDA√á√ÉO (JSONP) ‚Äî UMA √öNICA FUN√á√ÉO (SEM DUPLICAR)
  async function validarCliente(){
    const cpf = apenasNumeros(document.getElementById("cpf").value);
    const idPublico = String(document.getElementById("idPublico").value||"").trim();

    if(!cpf && !idPublico){
      alert("Informe CPF ou ID P√∫blico (APV-...).");
      return;
    }

    // Mant√©m compat√≠vel com o seu GS atual:
    // - Se voc√™ ainda usa modo=parceiro + token, mant√©m.
    // - Se voc√™ usar apenas token-app no GS, troque as 2 linhas marcadas abaixo.
    const params = new URLSearchParams();
    if(cpf) params.set("cpf", cpf);
    if(idPublico) params.set("idPublico", idPublico);

    // ====== (A) MODO ATUAL ======
    params.set("acao", "validarApp");
params.set("token-app", sessao.token);
params.set("cnpj", sessao.cnpj);
params.set("parceiro", sessao.nome);
params.set("origem", "validacao_parceiro");

    try{
      const data = await jsonp(API_URL + "?" + params.toString());
      mostrarResultado(data);
    }catch(err){
      console.error(err);
      mostrarResultado({ erro: "FALHA_API" });
    }
  }

  document.getElementById("btnValidar").addEventListener("click", validarCliente);

  // -------- QR Code --------
  let qr = null;

  function extrairDeQr(texto){
    const t = String(texto||"").trim();

    // Se vier uma URL do validar.html?idPublico=...
    try{
      const u = new URL(t);
      const id = u.searchParams.get("idPublico");
      if(id) return { idPublico: id.trim() };
    }catch(e){}

    // Se vier APV-...
    if(/^APV-[A-Z0-9-]{4,}$/i.test(t)) return { idPublico: t };

    // Se vier CPF num√©rico
    const n = apenasNumeros(t);
    if(n.length === 11) return { cpf: n };

    return null;
  }

  async function abrirQr(){
    document.getElementById("qrArea").style.display = "block";

    const Html5Qrcode = window.Html5Qrcode;
    if(!Html5Qrcode){
      alert("Biblioteca do QR n√£o carregou. Verifique internet/cache.");
      return;
    }

    if(qr) return;

    qr = new Html5Qrcode("qr-reader");
    try{
      await qr.start(
        { facingMode: "environment" },
        { fps: 10, qrbox: { width: 260, height: 260 } },
        (decodedText) => {
          const r = extrairDeQr(decodedText);
          if(!r) return;

          if(r.cpf) document.getElementById("cpf").value = r.cpf;
          if(r.idPublico) document.getElementById("idPublico").value = r.idPublico;

          fecharQr();
          validarCliente();
        }
      );
    } catch(err){
      alert("N√£o foi poss√≠vel acessar a c√¢mera. Permita a c√¢mera e use HTTPS (Vercel).");
      console.error(err);
      fecharQr();
    }
  }
function mesclarCPF(cpf){
  const n = String(cpf || "").replace(/\D/g,"");
  if(n.length !== 11) return cpf;
  return `${n.slice(0,3)}.***.***-${n.slice(9)}`;
}

  async function fecharQr(){
    document.getElementById("qrArea").style.display = "none";
    try{
      if(qr){
        await qr.stop();
        await qr.clear();
      }
    }catch(e){}
    qr = null;
  }

  document.getElementById("btnQr").addEventListener("click", abrirQr);
  document.getElementById("btnFecharQr").addEventListener("click", fecharQr);
function sairApp() {
localStorage.removeItem("app_token");
localStorage.removeItem("app_parceiro_cnpj");
localStorage.removeItem("app_parceiro_nome");
window.location.href = "login-app.html";

}

</script>

</body>
</html>
