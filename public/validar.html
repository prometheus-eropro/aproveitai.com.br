<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Valida√ß√£o por QR Code - Cart√£o AproveitAI</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="manifest" href="manifest-validar.json">
<link rel="icon" href="icon-192.png">

<style>
body {
  font-family: Arial, sans-serif;
  margin: 0;
  background: #aee6ff;
  text-align: center;
}

header {
  background: #fff;
  padding: 20px;
}

h1 {
  color: #0a7c3a;
}

button {
  padding: 14px 22px;
  font-size: 16px;
  border: none;
  border-radius: 6px;
  cursor: pointer;
}

.btn {
  background: #1fa84f;
  color: #fff;
  margin: 10px;
}

.btn:hover {
  opacity: 0.9;
}

#reader {
  width: 280px;
  margin: 20px auto;
}

.result {
  max-width: 420px;
  margin: 20px auto;
  padding: 16px;
  border-radius: 8px;
  font-size: 16px;
}

.ok {
  background: #e6fff1;
  border: 2px solid #1fa84f;
  color: #0a7c3a;
}

.erro {
  background: #ffecec;
  border: 2px solid #d93025;
  color: #a10000;
}

footer {
  background: #dff5e1;
  padding: 12px;
  font-size: 12px;
}
</style>

<script src="https://unpkg.com/html5-qrcode"></script>
</head>

<body>

<header>
  <h1>Cart√£o AproveitAI</h1>
  <strong>Valida√ß√£o por QR Code</strong><br>
  √Årea exclusiva do parceiro
</header>

<br>

<button class="btn" onclick="iniciarCamera()">üì∑ Iniciar c√¢mera</button>

<div id="reader"></div>

<div id="resultado"></div>

<button class="btn" onclick="voltarPainel()">‚¨Ö Voltar ao Painel</button>

<footer>
¬© 2025 Cart√£o AproveitAI ¬∑ PROMETHEUS EROPRO<br>
O Cart√£o AproveitAI n√£o garante descontos. Benef√≠cios s√£o definidos pelos parceiros.
</footer>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbzhwXhtWdsDSuABRneoz6QAD1SxpnMq3vc8e1FhtknlB7_1j6qLjYIbPA0qPJS7ck7y/exec";
let scanner = null;

function iniciarCamera() {
  document.getElementById("resultado").innerHTML = "";

  if (scanner) {
    scanner.clear();
  }

  scanner = new Html5Qrcode("reader");

  Html5Qrcode.getCameras().then(devices => {
    if (!devices.length) {
      alert("Nenhuma c√¢mera encontrada.");
      return;
    }

    scanner.start(
      devices[0].id,
      { fps: 10, qrbox: 250 },
      onScanSuccess
    ).catch(err => {
      alert("Erro ao acessar a c√¢mera.");
      console.error(err);
    });
  });
}

function onScanSuccess(textoQR) {
  pararCamera();
  validarCodigo(textoQR.trim());
}

function pararCamera() {
  if (scanner) {
    scanner.stop().then(() => {
      scanner.clear();
    }).catch(() => {});
  }
}

function validarCodigo(codigo) {
  document.getElementById("resultado").innerHTML =
    "<div class='result'>Consultando...</div>";

  fetch(API_URL + "?validar=1&codigo=" + encodeURIComponent(codigo))
    .then(r => r.json())
    .then(dados => {
      mostrarResultado(dados);
    })
    .catch(() => {
      mostrarErro("Erro ao consultar servidor.");
    });
}

function mostrarResultado(d) {
  if (!d || d.encontrado !== true) {
    mostrarErro("Cliente n√£o encontrado.");
    return;
  }

  if (d.ativo !== true) {
    mostrarErro("Cliente INATIVO. Desconto n√£o liberado.");
    return;
  }

  document.getElementById("resultado").innerHTML = `
    <div class="result ok">
      <strong>CLIENTE ATIVO</strong><br><br>
      Nome: ${d.nome}<br>
      C√≥digo do Cart√£o: ${d.codigo}<br>
      Autoriza√ß√£o: <strong>${d.codigoERO}</strong><br><br>
      ‚úî Desconto liberado
    </div>
  `;
}

function mostrarErro(msg) {
  document.getElementById("resultado").innerHTML = `
    <div class="result erro">‚ùå ${msg}</div>
  `;
}

function voltarPainel() {
  pararCamera();
  window.location.href = "painelparceiro.html";
}
</script>

</body>
</html>
