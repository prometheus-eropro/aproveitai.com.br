<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Valida√ß√£o de Benef√≠cio | Parceiro</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  body { font-family: Arial, sans-serif; background:#eaf6ff; padding:20px; }
  .container { max-width:420px; margin:auto; background:#fff; padding:20px; border-radius:10px; }
  h2 { color:#0a7a3c; text-align:center; }
  label { display:block; margin-top:15px; font-weight:600; }
  input, button { width:100%; padding:10px; margin-top:5px; box-sizing:border-box; }
  button { background:#0a7a3c; color:#fff; border:none; border-radius:6px; margin-top:20px; cursor:pointer; }
  button:disabled { opacity:.6; cursor:not-allowed; }
  .msg { margin-top:15px; font-weight:bold; text-align:center; min-height:20px; }
  .site-header { background:white; padding:10px; box-shadow:0 2px 5px rgba(0,0,0,0.1); }
  .brandline { display:flex; align-items:center; justify-content:space-between; gap:15px; flex-wrap:wrap; }
  .logo { max-height:180px; height:auto; width:auto; object-fit:contain; }
  .brand-center { flex:1; text-align:center; }
  .site-title { font-size:36px; color:#0a7a2a; text-shadow:1px 1px 3px rgba(0,0,0,0.3); font-weight:bold; margin:0; }
  .slogan { font-size:16px; font-style:italic; margin:6px 0 5px; color:#555; }
  .boas-vindas { background:#dfffe0; padding:12px 15px; border-radius:8px; margin-top:10px; font-size:18px; line-height:1.5; font-weight:600; box-shadow:0 1px 3px rgba(0,0,0,0.08); }
  .footer { background:#dfffe0; color:#222; padding:10px; font-size:13px; border-top:3px solid white; text-align:center; }
body {
  margin: 0;
  padding: 0;
  background: #eaf6ff;
  font-family: 'Segoe UI', Arial, sans-serif;
}

.main-container {
  max-width: 420px;
  margin: 0 auto;
  padding: 12px;
}

</style>
</head>

<body>
<header class="site-header">
  <div class="brandline">
    <img src="logo-prometheus.png" class="logo logo-prometheus" alt="Prometheus">
    <div class="brand-center">
      <h1 class="site-title">Plataforma AproveitAI</h1>
      <p class="slogan">Tecnologia com Consci√™ncIA gera Resultado.</p>
      <p class="boas-vindas">
        üè™ <strong>VALIDADOR QR CODE PARCEIRO</strong><br>
        Valide o QR CODE do parceiro, seu cart√£o estando ativo voc√™ receber√° o c√≥digo de autoriza√ß√£o do benef√≠cio.
      </p>
    </div>
    <img src="logo-aproveitai.png" class="logo logo-aproveitai" alt="Aproveitai">
  </div>
</header>

<div style="background:#fff3cd;color:#856404;padding:8px;text-align:center;font-size:13px;">
  ‚ö†Ô∏è Descontos sujeitos √† valida√ß√£o no sistema e √†s regras do parceiro.
</div>

<div class="container">
  <h2>Valida√ß√£o de Benef√≠cio</h2>

  <label>CPF do Cliente</label>
  <input id="cpf" placeholder="Somente n√∫meros" inputmode="numeric">

  <div id="blocoVeiculo" style="display:none">
    <label>Placa do ve√≠culo</label>
    <input id="placa" placeholder="ABC-1234">
  </div>

  <button id="btnValidar" onclick="validar()">Validar</button>
<div id="blocoCodigo" style="display:none; margin-top:20px;" class="msg">
  <div style="
    background:#d4edda;
    border:2px solid #198754;
    border-radius:10px;
    padding:15px;
  ">
    <div style="font-size:22px;font-weight:bold;color:#0a7a3c">
      üéü C√≥digo: <span id="codigoERO"></span>
    </div>
<div style="margin-top:12px;font-size:14px;color:#333;text-align:left">
  <strong>Parceiro:</strong> <span id="nomeParceiro"></span><br>
  <strong>Cliente:</strong> <span id="nomeCliente"></span><br>
  <strong>Grupo:</strong> <span id="grupoCliente"></span><br>
  <strong>ID P√∫blico:</strong> <span id="idPublicoCliente"></span><br>
  <div id="infoVeiculo" style="display:none">
    <strong>Ve√≠culo:</strong> <span id="placaVeiculo"></span>
  </div>
</div>

    <div id="timer" style="
      margin-top:10px;
      font-size:16px;
      color:#b91c1c;
      font-weight:bold;
    "></div>
<button id="btnConfirmar" onclick="confirmarUso()">
  ‚úÖ Confirmar desconto concedido
</button>

    <div style="font-size:13px;margin-top:8px;color:#444">
      Apresente este c√≥digo ao parceiro antes do tempo acabar.
    </div>
  </div>
</div>

  <div id="msg" class="msg"></div>
</div>

<script>
/* =============================
   CONFIGURA√á√ÉO
============================= */
const GAS_URL = "https://script.google.com/macros/s/AKfycbzHJgHVFPc7jM47MenTIxTD3hPiMJUPjIdeknpU_3GOP3WmV1ubCbaJ7m1jrSU2M4Fksg/exec";

let intervaloCronometro = null;

const params = new URLSearchParams(window.location.search);
const parceiroId = params.get("p") || params.get("parceiro_id") || params.get("id") || params.get("parceiro");


const elMsg = document.getElementById("msg");
const elBtn = document.getElementById("btnValidar");

/* =============================
   UTILIDADES
============================= */
function mostrarMsg(msg) {
  elMsg.innerHTML = msg || "";
}

function somenteNumeros(v) {
  return String(v || "").replace(/\D/g, "");
}

/* =============================
   VALIDA√á√ÉO
============================= */
function validar() {
  const cpf = document.getElementById("cpf").value.replace(/\D/g, "");
  if (cpf.length !== 11) {
    mostrarMsg("‚ö†Ô∏è CPF inv√°lido");
    return;
  }

  if (!parceiroId) {
    mostrarMsg("‚ùå QR Code inv√°lido");
    return;
  }

  mostrarMsg("‚è≥ Validando benef√≠cio...");

const old = document.getElementById("jsonpReq");
if(old) old.remove();

const script = document.createElement("script");
script.id = "jsonpReq";
script.src =
  GAS_URL +
  "?callback=retornoValidacao" +
  "&acao=validarParceiro" +
  "&cpf=" + encodeURIComponent(cpf) +
  "&p=" + encodeURIComponent(parceiroId);
document.body.appendChild(script);
}
// =============================
// CONTROLE DO CRON√îMETRO
// =============================
function retornoValidacao(resp) {

  console.log("RETORNO GAS:", resp);

  if (!resp || resp.ok !== true) {
    mostrarMsg(resp?.mensagem || "‚ùå Falha ao validar");
    return;
  }

  // ===== C√ìDIGO ERO =====
  const codigo =
    resp.codigoERO ||
    resp.codigo ||
    "";

  if (!codigo) {
    mostrarMsg("‚ùå C√≥digo ERO n√£o retornado");
    return;
  }

// ===== MOSTRAR BLOCO =====
document.getElementById("blocoCodigo").style.display = "block";

// ===== C√ìDIGO ERO =====
document.getElementById("codigoERO").innerText =
  resp.codigo || "-";

// ===== DADOS ESSENCIAIS =====
document.getElementById("nomeParceiro").innerText =
  resp.nomeParceiro || "-";

document.getElementById("nomeCliente").innerText =
  resp.nomeCliente || "-";

// ===== CAMPOS N√ÉO IMPLEMENTADOS (VERS√ÉO 1) =====
document.getElementById("grupoCliente").innerText = resp.grupo || "-";
document.getElementById("idPublicoCliente").innerText = resp.idPublico || "-";


// ===== TIMER SIMPLES =====
document.getElementById("timer").innerText =
  "‚è≥ V√°lido por 10 minutos";
  // ===== VE√çCULO (SE EXISTIR) =====
  if (resp.veiculo?.placa || resp.placa) {
    document.getElementById("infoVeiculo").style.display = "block";
    document.getElementById("placaVeiculo").innerText =
      resp.veiculo?.placa || resp.placa;
  }

  // ===== CRON√îMETRO =====
  if (resp.validoAte) {
    iniciarCronometro(resp.validoAte);
  } else {
    document.getElementById("timer").innerText =
      "‚è≥ V√°lido por 10 minutos";
  }
}
function confirmarDesconto() {
  const codigo = document.getElementById("codigoERO").innerText;

  if (!codigo) {
    mostrarMsg("C√≥digo inv√°lido");
    return;
  }

  const script = document.createElement("script");
  script.src = GAS_URL +
    "?callback=retornoConfirmacao" +
    "&acao=confirmarERO" +
    "&codigo=" + encodeURIComponent(codigo) +
    "&canal=SITE";
  document.body.appendChild(script);
}

function retornoConfirmacao(resp) {
  console.log("RETORNO CONFIRMA√á√ÉO:", resp);
document.querySelector("#botaoConfirmar").disabled = true;

  if (!resp || resp.ok !== true) {
    mostrarMsg(resp?.msg || "‚ùå Erro ao confirmar desconto");
    pararCronometro(); // <=== ADICIONE ISSO
    return;
  }

  mostrarMsg("‚úÖ Desconto confirmado com sucesso!", "verde");
  pararCronometro(); // <=== ADICIONE ISSO
}
function retornoConfirmacao(resp){
  if(resp.ok){
    document.getElementById("timer").innerText =
      "‚úÖ Desconto confirmado no sistema";
    clearInterval(intervaloCronometro);
  } else {
    document.getElementById("timer").innerText =
      "‚ùå " + (resp.msg || "Erro ao confirmar");
  }
}
let timerInterval;

function iniciarCronometro(segundos) {
  let tempo = segundos;
  timerInterval = setInterval(() => {
    tempo--;
    atualizarDisplay(tempo);
    if (tempo <= 0) {
      clearInterval(timerInterval);
      mostrarMsg("‚è∞ Tempo esgotado!");
    }
  }, 1000);
}

function pararCronometro() {
  clearInterval(timerInterval);
}
</script>
<footer class="footer">
  ¬© 2025 Plataforma AproveitAI ‚Ä¢ PROMETHEUS EROPRO<br>
  <strong>Aviso legal:</strong> A Plataforma AproveitAI n√£o garante descontos. Benef√≠cios e promo√ß√µes s√£o definidos e concedidos exclusivamente pelos parceiros,
  v√°lidos, em regra, para pagamentos √† vista em moeda corrente, salvo autoriza√ß√£o expressa do estabelecimento.
</footer>
</body>
</html>
