<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Valida√ß√£o de Benef√≠cio | Parceiro</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  body { font-family: Arial, sans-serif; background:#eaf6ff; padding:20px; }
  .container { max-width:420px; margin:auto; background:#fff; padding:20px; border-radius:10px; }
  h2 { color:#0a7a3c; text-align:center; }
  label { display:block; margin-top:15px; font-weight:600; }
  input, button { width:100%; padding:10px; margin-top:5px; box-sizing:border-box; }
  button { background:#0a7a3c; color:#fff; border:none; border-radius:6px; margin-top:20px; cursor:pointer; }
  button:disabled { opacity:.6; cursor:not-allowed; }
  .msg { margin-top:15px; font-weight:bold; text-align:center; min-height:20px; }
  .site-header { background:white; padding:10px; box-shadow:0 2px 5px rgba(0,0,0,0.1); }
  .brandline { display:flex; align-items:center; justify-content:space-between; gap:15px; flex-wrap:wrap; }
  .logo { max-height:180px; height:auto; width:auto; object-fit:contain; }
  .brand-center { flex:1; text-align:center; }
  .site-title { font-size:36px; color:#0a7a2a; text-shadow:1px 1px 3px rgba(0,0,0,0.3); font-weight:bold; margin:0; }
  .slogan { font-size:16px; font-style:italic; margin:6px 0 5px; color:#555; }
  .boas-vindas { background:#dfffe0; padding:12px 15px; border-radius:8px; margin-top:10px; font-size:18px; line-height:1.5; font-weight:600; box-shadow:0 1px 3px rgba(0,0,0,0.08); }
  .footer { background:#dfffe0; color:#222; padding:10px; font-size:13px; border-top:3px solid white; text-align:center; }
body {
  margin: 0;
  padding: 0;
  background: #eaf6ff;
  font-family: 'Segoe UI', Arial, sans-serif;
}

.main-container {
  max-width: 420px;
  margin: 0 auto;
  padding: 12px;
}

</style>
</head>

<body>
<header class="site-header">
  <div class="brandline">
    <img src="logo-prometheus.png" class="logo logo-prometheus" alt="Prometheus">
    <div class="brand-center">
      <h1 class="site-title">Plataforma AproveitAI</h1>
      <p class="slogan">Tecnologia com Consci√™ncIA gera Resultado.</p>
      <p class="boas-vindas">
        üè™ <strong>VALIDADOR QR CODE PARCEIRO</strong><br>
        Valide o QR CODE do parceiro, seu cart√£o estando ativo voc√™ receber√° o c√≥digo de autoriza√ß√£o do benef√≠cio.
      </p>
    </div>
    <img src="logo-aproveitai.png" class="logo logo-aproveitai" alt="Aproveitai">
  </div>
</header>

<div style="background:#fff3cd;color:#856404;padding:8px;text-align:center;font-size:13px;">
  ‚ö†Ô∏è Descontos sujeitos √† valida√ß√£o no sistema e √†s regras do parceiro.
</div>

<div class="container">
  <h2>Valida√ß√£o de Benef√≠cio</h2>

  <label>CPF do Cliente</label>
  <input id="cpf" placeholder="Somente n√∫meros" inputmode="numeric">

  
<div id="blocoVeiculo" style="display:none">
  <label>Selecione o ve√≠culo</label>
  <select id="selectVeiculo" style="width:100%;padding:10px;margin-top:5px;"></select>
</div>


<button onclick="validar()">Validar</button>

<div id="blocoCodigo" style="display:none; margin-top:20px;" class="msg">
  <div style="
    background:#d4edda;
    border:2px solid #198754;
    border-radius:10px;
    padding:15px;
  ">
    <div style="font-size:22px;font-weight:bold;color:#0a7a3c">
      üéü C√≥digo: <span id="codigoERO"></span>
    </div>
<div style="margin-top:12px;font-size:14px;color:#333;text-align:left">
  <strong>Parceiro:</strong> <span id="nomeParceiro"></span><br>
  <strong>Cliente:</strong> <span id="nomeCliente"></span><br>
  <strong>Grupo:</strong> <span id="grupoCliente"></span><br>
  <strong>ID P√∫blico:</strong> <span id="idPublicoCliente"></span><br>
  <div id="infoVeiculo" style="display:none">
  <strong>Ve√≠culo:</strong> <span id="placaVeiculo"></span> ‚Äì <span id="modeloVeiculo"></span>
</div>

</div>

    <div id="timer" style="
      margin-top:10px;
      font-size:16px;
      color:#b91c1c;
      font-weight:bold;
    "></div>
<button id="btnConfirmar" onclick="confirmarDesconto()">
  ‚úÖ Confirmar desconto concedido
</button>

    <div style="font-size:13px;margin-top:8px;color:#444">
      Apresente este c√≥digo ao parceiro antes do tempo acabar.
    </div>
  </div>
</div>

  <div id="msg" class="msg"></div>
</div>

<script>
/* =============================
   CONFIGURA√á√ÉO
============================= */
const GAS_URL = "https://script.google.com/macros/s/AKfycbzHJgHVFPc7jM47MenTIxTD3hPiMJUPjIdeknpU_3GOP3WmV1ubCbaJ7m1jrSU2M4Fksg/exec";

let intervaloCronometro = null;

const params = new URLSearchParams(window.location.search);
const parceiroId = params.get("p") || params.get("parceiro_id") || params.get("id") || params.get("parceiro");


const elMsg = document.getElementById("msg");
const elBtn = document.getElementById("btnValidar");

/* =============================
   UTILIDADES
============================= */
function mostrarMsg(msg) {
  elMsg.innerHTML = msg || "";
}

function somenteNumeros(v) {
  return String(v || "").replace(/\D/g, "");
}

/* =============================
   VALIDA√á√ÉO
============================= */
function validar() {
  const cpf = document.getElementById("cpf").value.replace(/\D/g, "");
  if (cpf.length !== 11) {
    mostrarMsg("‚ö†Ô∏è CPF inv√°lido");
    return;
  }

  if (!parceiroId) {
    mostrarMsg("‚ùå QR Code inv√°lido");
    return;
  }

  mostrarMsg("‚è≥ Validando benef√≠cio...");

const old = document.getElementById("jsonpReq");
if(old) old.remove();

const script = document.createElement("script");
script.id = "jsonpReq";
script.src =
  GAS_URL +
  "?callback=retornoValidacao" +
  "&acao=validarParceiro" +
  "&cpf=" + encodeURIComponent(cpf) +
  "&p=" + encodeURIComponent(parceiroId);
document.body.appendChild(script);
}
// =============================
// CONTROLE DO CRON√îMETRO
// =============================
function retornoValidacao(resp) {
  console.log("RETORNO GAS:", resp);
  console.log("CELULAR:", resp.celular);

  if (!resp || resp.ok !== true) {
    mostrarMsg(resp?.mensagem || "‚ùå Falha ao validar");
    return;
  }

  // ===== VE√çCULO (UM OU DOIS) =====
 // Preencher combo de ve√≠culos se houver dois
if ((resp.placa && resp.modelo) || (resp.placa2 && resp.modelo2)) {
  const select = document.getElementById("selectVeiculo");
  select.innerHTML = "";

  const op1 = document.createElement("option");
  op1.value = `${resp.placa}|${resp.modelo}`;
  op1.text = `${resp.placa} ‚Äì ${resp.modelo}`;
  select.appendChild(op1);

  if (resp.placa2 && resp.modelo2) {
    const op2 = document.createElement("option");
    op2.value = `${resp.placa2}|${resp.modelo2}`;
    op2.text = `${resp.placa2} ‚Äì ${resp.modelo2}`;
    select.appendChild(op2);
  }
if (!resp.placa2) {
  document.getElementById("placaVeiculo").innerText = resp.placa;
  document.getElementById("modeloVeiculo").innerText = resp.modelo;
}

  document.getElementById("blocoVeiculo").style.display = "block";
}
  // ===== C√ìDIGO ERO =====
  const codigo = resp.codigoERO || resp.codigo || "";
  if (!codigo) {
    mostrarMsg("‚ùå C√≥digo ERO n√£o retornado");
    return;
  }

  document.getElementById("blocoCodigo").style.display = "block";
  document.getElementById("codigoERO").innerText = codigo;
  document.getElementById("nomeParceiro").innerText = resp.nomeParceiro || "-";
  document.getElementById("nomeCliente").innerText = resp.nomeCliente || "-";
  document.getElementById("grupoCliente").innerText = resp.grupo || "-";
  document.getElementById("idPublicoCliente").innerText = resp.idPublico || "-";
  document.getElementById("timer").innerText = "‚è≥ V√°lido por 10 minutos";
window.ultimoCelularCliente = resp.celular || "";

document.getElementById("infoVeiculo").style.display = "block";

  if (resp.validoAte) {
    iniciarCronometro(resp.validoAte);
  }
}
function confirmarDesconto() {
  const codigo = document.getElementById("codigoERO").innerText;

  if (!codigo) {
    mostrarMsg("C√≥digo inv√°lido");
    return;
  }

  let placa = "";
  let modelo = "";

  const selectVeiculo = document.getElementById("selectVeiculo");
  if (selectVeiculo && selectVeiculo.value) {
    const [p, m] = selectVeiculo.value.split("|");
    placa = p;
    modelo = m;
  }

  document.getElementById("placaVeiculo").innerText = placa;
  document.getElementById("modeloVeiculo").innerText = modelo;

  const script = document.createElement("script");
  script.src = GAS_URL +
    "?callback=retornoConfirmacao" +
    "&acao=confirmarERO" +
    "&codigoERO=" + encodeURIComponent(codigo) +
    "&placa=" + encodeURIComponent(placa) +
    "&modelo=" + encodeURIComponent(modelo) +
    "&canal=SITE" +
    "&whatsapp=1" +
    "&celular=" + encodeURIComponent(window.ultimoCelularCliente);
  document.body.appendChild(script);
}
function retornoConfirmacao(resp) {
  console.log("RETORNO CONFIRMA√á√ÉO:", resp);
  document.getElementById("btnConfirmar").disabled = true;

  if (!resp || resp.ok !== true) {
    mostrarMsg(resp?.msg || "‚ùå Erro ao confirmar desconto");
    pararCronometro();
    return;
  }

  mostrarMsg("‚úÖ Desconto confirmado com sucesso!");
  document.getElementById("timer").innerText = "‚úÖ Desconto confirmado no sistema";

  // ‚òëÔ∏è CHAMADA CORRETA PARA PARAR
  pararCronometro();
}
  // ‚òëÔ∏è ENVIO WHATSAPP
  
let timerInterval;

function iniciarCronometro(validoAte) {
  const fim = new Date(validoAte).getTime();

  intervaloCronometro = setInterval(() => {
    const agora = Date.now();
    const restante = Math.floor((fim - agora) / 1000);

    if (restante <= 0) {
      clearInterval(intervaloCronometro);
      document.getElementById("timer").innerText = "‚è∞ Tempo esgotado!";
      return;
    }

    const minutos = Math.floor(restante / 60);
    const segundos = restante % 60;
    document.getElementById("timer").innerText =
      `‚è≥ Tempo restante: ${minutos}m ${segundos}s`;
  }, 1000);
}

function pararCronometro() {
  clearInterval(intervaloCronometro);
};

</script>
<footer class="footer">
  ¬© 2025 Plataforma AproveitAI ‚Ä¢ PROMETHEUS EROPRO<br>
  <strong>Aviso legal:</strong> A Plataforma AproveitAI n√£o garante descontos. Benef√≠cios e promo√ß√µes s√£o definidos e concedidos exclusivamente pelos parceiros,
  v√°lidos, em regra, para pagamentos √† vista em moeda corrente, salvo autoriza√ß√£o expressa do estabelecimento.
</footer>
</body>
</html>
